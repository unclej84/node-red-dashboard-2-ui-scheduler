<!--
MIT License

Copyright (c) 2019, 2020, 2021, 2022 Steve-Mcl

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
-->

<script type="text/javascript">
    /* global RED, $, jQuery */
    /* global cartodb, L */
    (function ($) {
        /*
            cronBuilder - adapted for ui-scheduler from https://github.com/juliacscai/jquery-cron-quartz - License...
            The MIT License (MIT)
            Copyright (c) 2016 Julia Cai
        */

        const cronInputs = {
            period: '<div class="cron-select-period"><label></label><select class="cron-period-select"></select></div>',
            startTime: '<div class="cron-input cron-start-time">Start time <select class="cron-clock-hour"></select>:<select class="cron-clock-minute"></select></div>',
            container: '<div class="cron-input"></div>',
            minutes: {
                tag: 'cron-minutes',
                inputs: ['<p>Every <select class="cron-minutes-select"></select> minutes(s)</p>']
            },
            hourly: {
                tag: 'cron-hourly',
                inputs: ['<p><input type="radio" name="hourlyType" value="every"> Every <select class="cron-hourly-select"></select> hour(s)</p>',
                    '<p><input type="radio" name="hourlyType" value="clock"> Every day at <select class="cron-hourly-hour"></select>:<select class="cron-hourly-minute"></select></p>']
            },
            daily: {
                tag: 'cron-daily',
                inputs: ['<p><input type="radio" name="dailyType" value="every"> Every <select class="cron-daily-select"></select> day(s)</p>',
                    '<p><input type="radio" name="dailyType" value="clock"> Every week day</p>']
            },
            weekly: {
                tag: 'cron-weekly',
                inputs: ['<p><input type="checkbox" name="dayOfWeekMon"> Monday  <input type="checkbox" name="dayOfWeekTue"> Tuesday  ' +
                    '<input type="checkbox" name="dayOfWeekWed"> Wednesday  <input type="checkbox" name="dayOfWeekThu"> Thursday</p>',
                '<p><input type="checkbox" name="dayOfWeekFri"> Friday  <input type="checkbox" name="dayOfWeekSat"> Saturday  ' +
                '<input type="checkbox" name="dayOfWeekSun"> Sunday</p>']
            },
            monthly: {
                tag: 'cron-monthly',
                inputs: ['<p><input type="radio" name="monthlyType" value="byDay"> Day <select class="cron-monthly-day"></select> of every <select class="cron-monthly-month"></select> month(s)</p>',
                    '<p><input type="radio" name="monthlyType" value="byWeek"> The <select class="cron-monthly-nth-day"></select> ' +
                    '<select class="cron-monthly-day-of-week"></select> of every <select class="cron-monthly-month-by-week"></select> month(s)</p>']
            },
            yearly: {
                tag: 'cron-yearly',
                inputs: ['<p><input type="radio" name="yearlyType" value="byDay"> Every <select class="cron-yearly-month"></select> <select class="cron-yearly-day"></select></p>',
                    '<p><input type="radio" name="yearlyType" value="byWeek"> The <select class="cron-yearly-nth-day"></select> ' +
                    '<select class="cron-yearly-day-of-week"></select> of <select class="cron-yearly-month-by-week"></select></p>']
            }
        }

        const periodOpts = arrayToOptions(['Minutes', 'Hourly', 'Daily', 'Weekly', 'Monthly', 'Yearly'])
        const minuteOpts = rangeToOptions(1, 59)
        const hourOpts = rangeToOptions(1, 24)
        const dayOpts = rangeToOptions(1, 31)
        const minuteClockOpts = rangeToOptions(0, 59, true)
        const hourClockOpts = rangeToOptions(0, 23, true)
        const dayInMonthOpts = rangeToOptions(1, 31)
        const monthOpts = arrayToOptions(['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
            [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12])
        const monthNumOpts = rangeToOptions(1, 12)
        const nthWeekOpts = arrayToOptions(['First', 'Second', 'Third', 'Forth', 'Last'], [1, 2, 3, 4, 'L'])
        const dayOfWeekOpts = arrayToOptions(['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'], ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'])

        // Convert an array of values to options to append to select input
        function arrayToOptions (opts, values) {
            let inputOpts = ''
            for (let i = 0; i < opts.length; i++) {
                let value = opts[i]
                if (values != null) value = values[i]
                inputOpts += "<option value='" + value + "'>" + opts[i] + '</option>\n'
            }
            return inputOpts
        }

        // Convert an integer range to options to append to select input
        function rangeToOptions (start, end, isClock) {
            let inputOpts = ''; let label
            for (let i = start; i <= end; i++) {
                if (isClock && i < 10) label = '0' + i
                else label = i
                inputOpts += "<option value='" + i + "'>" + label + '</option>\n'
            }
            return inputOpts
        }

        // Add input elements to UI as defined in cronInputs
        function addInputElements ($baseEl, inputObj, onFinish) {
            $(cronInputs.container).addClass(inputObj.tag).appendTo($baseEl)
            $baseEl.children('.' + inputObj.tag).append(inputObj.inputs)
            if (typeof onFinish === 'function') onFinish()
        }

        const eventHandlers = {
            periodSelect: function () {
                const period = ($(this).val())
                const $selector = $(this).parent()
                $selector.siblings('div.cron-input').hide()
                $selector.siblings().find('select option').removeAttr('selected')
                $selector.siblings().find('select option:first').attr('selected', 'selected')
                $selector.siblings('div.cron-start-time').show()
                $selector.siblings('div.cron-start-time').children('select.cron-clock-hour').val('12')
                switch (period) {
                case 'Minutes':
                    $selector.siblings('div.cron-minutes')
                        .show()
                        .find('select.cron-minutes-select').val('1')
                    $selector.siblings('div.cron-start-time').hide()
                    break
                case 'Hourly': {
                    const $hourlyEl = $selector.siblings('div.cron-hourly')
                    $hourlyEl.show()
                        .find('input[name=hourlyType][value=every]').prop('checked', true)
                    $hourlyEl.find('select.cron-hourly-hour').val('12')
                    $selector.siblings('div.cron-start-time').hide()
                }
                    break
                case 'Daily': {
                    const $dailyEl = $selector.siblings('div.cron-daily')
                    $dailyEl.show()
                        .find('input[name=dailyType][value=every]').prop('checked', true)
                }
                    break
                case 'Weekly':
                    $selector.siblings('div.cron-weekly')
                        .show()
                        .find('input[type=checkbox]').prop('checked', false)
                    break
                case 'Monthly': {
                    const $monthlyEl = $selector.siblings('div.cron-monthly')
                    $monthlyEl.show()
                        .find('input[name=monthlyType][value=byDay]').prop('checked', true)
                }
                    break
                case 'Yearly': {
                    const $yearlyEl = $selector.siblings('div.cron-yearly')
                    $yearlyEl.show()
                        .find('input[name=yearlyType][value=byDay]').prop('checked', true)
                }
                    break
                }
            }
        }

        // Public functions
        $.cronBuilder = function (el, options) {
            const base = this

            // Access to jQuery and DOM versions of element
            base.$el = $(el)
            base.el = el

            // Reverse reference to the DOM object
            base.$el.data('cronBuilder', base)

            // Initialization
            base.init = function () {
                base.options = $.extend({}, $.cronBuilder.defaultOptions, options)
                base.$el.append(cronInputs.period)
                base.$el.find('div.cron-select-period label').text(base.options.selectorLabel)
                base.$el.find('select.cron-period-select')
                    .append(periodOpts)
                    .bind('change', eventHandlers.periodSelect)

                addInputElements(base.$el, cronInputs.minutes, function () {
                    base.$el.find('select.cron-minutes-select').append(minuteOpts)
                })

                addInputElements(base.$el, cronInputs.hourly, function () {
                    base.$el.find('select.cron-hourly-select').append(hourOpts)
                    base.$el.find('select.cron-hourly-hour').append(hourClockOpts)
                    base.$el.find('select.cron-hourly-minute').append(minuteClockOpts)
                })

                addInputElements(base.$el, cronInputs.daily, function () {
                    base.$el.find('select.cron-daily-select').append(dayOpts)
                })

                addInputElements(base.$el, cronInputs.weekly)

                addInputElements(base.$el, cronInputs.monthly, function () {
                    base.$el.find('select.cron-monthly-day').append(dayInMonthOpts)
                    base.$el.find('select.cron-monthly-month').append(monthNumOpts)
                    base.$el.find('select.cron-monthly-nth-day').append(nthWeekOpts)
                    base.$el.find('select.cron-monthly-day-of-week').append(dayOfWeekOpts)
                    base.$el.find('select.cron-monthly-month-by-week').append(monthNumOpts)
                })

                addInputElements(base.$el, cronInputs.yearly, function () {
                    base.$el.find('select.cron-yearly-month').append(monthOpts)
                    base.$el.find('select.cron-yearly-day').append(dayInMonthOpts)
                    base.$el.find('select.cron-yearly-nth-day').append(nthWeekOpts)
                    base.$el.find('select.cron-yearly-day-of-week').append(dayOfWeekOpts)
                    base.$el.find('select.cron-yearly-month-by-week').append(monthOpts)
                })

                base.$el.append(cronInputs.startTime)
                base.$el.find('select.cron-clock-hour').append(hourClockOpts)
                base.$el.find('select.cron-clock-minute').append(minuteClockOpts)

                if (typeof base.options.onChange === 'function') {
                    base.$el.find('select, input').change(function () {
                        base.options.onChange(base.getExpression())
                    })
                }

                base.$el.find('select.cron-period-select')
                    .triggerHandler('change')
            }

            base.getExpression = function () {
                // var b = c.data("block");
                const sec = 0 // ignoring seconds by default
                const year = '*' // every year by default
                let dow = '?'
                let month = '*'; let dom = '*'
                let min = base.$el.find('select.cron-clock-minute').val()
                let hour = base.$el.find('select.cron-clock-hour').val()
                const period = base.$el.find('select.cron-period-select').val()
                switch (period) {
                case 'Minutes':
                    {
                        const $selector = base.$el.find('div.cron-minutes')
                        const nmin = $selector.find('select.cron-minutes-select').val()
                        if (nmin > 1) min = '0/' + nmin
                        else min = '*'
                        hour = '*'
                    }
                    break

                case 'Hourly':
                    {
                        const $selector = base.$el.find('div.cron-hourly')
                        if ($selector.find('input[name=hourlyType][value=every]').is(':checked')) {
                            min = 0
                            hour = '*'
                            const nhour = $selector.find('select.cron-hourly-select').val()
                            if (nhour > 1) hour = '0/' + nhour
                        } else {
                            min = $selector.find('select.cron-hourly-minute').val()
                            hour = $selector.find('select.cron-hourly-hour').val()
                        }
                    }
                    break

                case 'Daily':
                    {
                        const $selector = base.$el.find('div.cron-daily')
                        if ($selector.find('input[name=dailyType][value=every]').is(':checked')) {
                            const ndom = $selector.find('select.cron-daily-select').val()
                            if (ndom > 1) dom = '1/' + ndom
                        } else {
                            dom = '?'
                            dow = 'MON-FRI'
                        }
                    }
                    break

                case 'Weekly':
                    {
                        const $selector = base.$el.find('div.cron-weekly')
                        const ndow = []
                        if ($selector.find('input[name=dayOfWeekMon]').is(':checked')) { ndow.push('MON') }
                        if ($selector.find('input[name=dayOfWeekTue]').is(':checked')) { ndow.push('TUE') }
                        if ($selector.find('input[name=dayOfWeekWed]').is(':checked')) { ndow.push('WED') }
                        if ($selector.find('input[name=dayOfWeekThu]').is(':checked')) { ndow.push('THU') }
                        if ($selector.find('input[name=dayOfWeekFri]').is(':checked')) { ndow.push('FRI') }
                        if ($selector.find('input[name=dayOfWeekSat]').is(':checked')) { ndow.push('SAT') }
                        if ($selector.find('input[name=dayOfWeekSun]').is(':checked')) { ndow.push('SUN') }
                        dow = '*'
                        dom = '?'
                        if (ndow.length < 7 && ndow.length > 0) dow = ndow.join(',')
                    }
                    break

                case 'Monthly':
                    {
                        const $selector = base.$el.find('div.cron-monthly')
                        let nmonth
                        let mnd
                        if ($selector.find('input[name=monthlyType][value=byDay]').is(':checked')) {
                            month = '*'
                            nmonth = $selector.find('select.cron-monthly-month').val()
                            dom = $selector.find('select.cron-monthly-day').val()
                            dow = '?'
                        } else {
                            mnd = $selector.find('select.cron-monthly-nth-day').val()
                            dow = $selector.find('select.cron-monthly-day-of-week').val() +
                                    (mnd === 'L' ? 'L' : '#' + mnd)
                            nmonth = $selector.find('select.cron-monthly-month-by-week').val()
                            dom = '?'
                        }
                        if (nmonth > 1) month = '1/' + nmonth
                    }
                    break

                case 'Yearly':
                    {
                        const $selector = base.$el.find('div.cron-yearly')
                        let ynd
                        if ($selector.find('input[name=yearlyType][value=byDay]').is(':checked')) {
                            dom = $selector.find('select.cron-yearly-day').val()
                            month = $selector.find('select.cron-yearly-month').val()
                            dow = '?'
                        } else {
                            ynd = $selector.find('select.cron-yearly-nth-day').val()
                            dow = $selector.find('select.cron-yearly-day-of-week').val() +
                                    (ynd === 'L' ? 'L' : '#' + ynd)
                            month = $selector.find('select.cron-yearly-month-by-week').val()
                            dom = '?'
                        }
                    }
                    break

                default:
                    break
                }
                return [sec, min, hour, dom, month, dow, year].join(' ')
            }

            base.init()
        }

        // Plugin default options
        $.cronBuilder.defaultOptions = {
            selectorLabel: 'Select period: '
        }

        // Plugin definition
        $.fn.cronBuilder = function (options) {
            return this.each(function () {
                // eslint-disable-next-line no-new, new-cap
                (new $.cronBuilder(this, options))
            })
        }
    }(jQuery));

    (function () {
        function hasProperty (obj, prop) {
            return Object.prototype.hasOwnProperty.call(obj, prop)
        }

        RED._cron_plus_debug = true // set true at runtime to enable debug output
        let map, mapPopup, selectedLocation, selectedLocationInput
        const filesAdded = [] // list of files already added

        function toggleFullscreen (selector, callback) {
            callback = callback || function () { }
            const el = document.querySelector(selector || '#node-ui-scheduler-tab-static-schedules')
            const $el = $(el)
            if (!document.fullscreenElement) {
                // eslint-disable-next-line promise/always-return
                el.requestFullscreen().then(() => {
                    $el.addClass('ui-scheduler-fullscreen-element').removeClass('ui-scheduler-expanded-element')
                    // eslint-disable-next-line promise/no-callback-in-promise
                    callback()
                }).catch((err) => {
                    if (callback) {
                        callback(err)
                    } else {
                        alert(`Unable to get fullscreen mode: ${err.message}`)
                    }
                })
            } else {
                $el.removeClass('ui-scheduler-fullscreen-element').removeClass('ui-scheduler-expanded-element')
                try {
                    document.exitFullscreen()
                } finally {
                    callback()
                }
            }
        }

        function checkLoadJsCssFile (filename, filetype, callback) {
            if (filesAdded.indexOf(filename) === -1) {
                loadJsCssFile(filename, filetype, function () {
                    filesAdded.push(filename)
                    if (callback) callback()
                })
            } else {
                if (callback) callback()
            }
        }

        function loadJsCssFile (filename, filetype, callback) {
            let fileRef
            if (filetype === 'js') { // if filename is a external JavaScript file
                fileRef = document.createElement('script')
                fileRef.setAttribute('type', 'text/javascript')
                fileRef.setAttribute('src', filename)
            } else if (filetype === 'css') { // if filename is an external CSS file
                fileRef = document.createElement('link')
                fileRef.setAttribute('rel', 'stylesheet')
                fileRef.setAttribute('type', 'text/css')
                fileRef.setAttribute('href', filename)
            }
            if (typeof fileRef !== 'undefined') { document.getElementsByTagName('head')[0].appendChild(fileRef) }

            fileRef.onload = function () {
                if (callback) callback()
            }
        }

        function generateUniqueId () {
            return '_' + Math.random().toString(36).substr(2, 9)
        }

        function safeFloat (value, def) {
            if ((undefined === value) || (value === null)) {
                return def || 0.0
            }
            try {
                value = parseFloat(value)
            } catch (e) {
                value = def || 0.0
            }
            if (isNaN(value)) {
                return def || 0.0
            }
            return value
        }

        function isCronLike (expression) {
            if (typeof expression !== 'string') return false
            if (expression.indexOf('*') >= 0) return true
            const cleaned = expression.replace(/\s\s+/g, ' ')
            const spaces = cleaned.split(' ')
            return spaces.length >= 4 && spaces.length <= 6
        }

        function isDateSequenceLike (expression) {
            try {
                if (typeof expression !== 'string') return false
                if (expression.indexOf('*') >= 0) return false
                if (expression.indexOf('#') >= 0) return false
                if (expression.indexOf('?') >= 0) return false
                const cleaned = expression.replace(/\s\s+/g, ' ')
                const parts = cleaned.split(',')
                for (let index = 0; index < parts.length; index++) {
                    let part = parts[index]
                    if (parseInt(part) === part) part = parseInt(part)
                    const d = new Date(part)
                    const isDate = (d instanceof Date && !isNaN(d.valueOf()))
                    if (!isDate) return false
                }
                return true
            } catch (error) {
                return false
            }
        }

        function showSidebarHelpPanel () {
            if (RED.sidebar.help) {
                RED.sidebar.help.show()//  >= V1.1.0
            } else {
                RED.sidebar.show('info')// <  V1.1.0
            }
        }

        function showCronHelp () {
            showSidebarHelpPanel()
            $('#ui-scheduler-expression-info').get(0).scrollIntoView()
        }

        function showSolarHelp () {
            showSidebarHelpPanel()
            $('#ui-scheduler-solar-events-info').get(0).scrollIntoView()
        }

        const getIdealDialogHeight = function () {
            return Math.min(800, ($(document).height() < 600) ? $(document).height() - 30 : $(document).height() - 100)
        }

        function initMap () {
            // create map popup dialog
            $('#ui-scheduler-map-dialog').dialog({
                classes: {
                    'ui-dialog-content': 'ui-scheduler-map-dialog-content'
                },
                autoOpen: false,
                height: getIdealDialogHeight(),
                width: '75%',
                minWidth: 300,
                maxWidth: 1000,
                modal: true,
                buttons: {
                    Cancel: function () {
                        $('#ui-scheduler-map-dialog').dialog('close')
                    },
                    OK: function () {
                        $('#ui-scheduler-map-dialog').dialog('close')
                        if (selectedLocation && selectedLocationInput) {
                            if (selectedLocationInput.typedInput('instance')) {
                                selectedLocationInput.typedInput('value', selectedLocation.lat + ' ' + selectedLocation.lng)
                            } else {
                                selectedLocationInput.val(selectedLocation.lat + ' ' + selectedLocation.lng)
                            }
                            selectedLocationInput.focus()
                            // if selectedLocationInput is a typedInput, trigger focus on that
                            if (selectedLocationInput.typedInput('instance')) {
                                selectedLocationInput.typedInput('focus')
                            }
                            selectedLocationInput.change()
                        }
                    }
                },
                show: {
                    effect: 'blind',
                    duration: 500
                },
                // eslint-disable-next-line no-unused-vars
                open: function (event) {
                    $(this).css('padding', '0px 0px 0px 0px')
                    $('.ui-dialog-buttonpane').find('button:contains("OK")').addClass('primary')
                    $('#ui-scheduler-map-dialog').dialog('option', 'height', getIdealDialogHeight())
                    $('#ui-scheduler-dynamic-nodes-dialog').dialog('option', 'position', { my: 'center', at: 'center', of: window })
                },
                hide: {
                    effect: 'explode',
                    duration: 500
                },
                // eslint-disable-next-line no-unused-vars
                close: function (event, ui) {
                    if (RED._cron_plus_debug) console.log('destroying map')
                    if (map) map.remove()
                }
            })
        }

        function createMap (srcInput) {
            if (RED._cron_plus_debug) {
                console.log('createMap', srcInput)
            }
            $('.ui-scheduler-map-loading').hide()
            if (!window.L || navigator.onLine === false) {
                $('.ui-scheduler-map-not-loaded').show()
                $('#ui-scheduler-map').hide()
                return
            }
            $('#ui-scheduler-map').show()
            $('.ui-scheduler-map-not-loaded').hide()
            let lat, lon
            selectedLocationInput = srcInput
            function getInputValue () {
                if (selectedLocationInput.typedInput('instance')) {
                    return selectedLocationInput.typedInput('value')
                }
                return selectedLocationInput.val()
            }
            const latlon = getInputValue()
            if (latlon && typeof latlon === 'string') {
                let splitChar = ' '
                if (latlon.includes(',')) splitChar = ','
                const arrLatlon = latlon.split(splitChar)
                if (arrLatlon.length >= 2) {
                    lat = arrLatlon[0]
                    lon = arrLatlon[1]
                }
            }
            if (RED._cron_plus_debug) console.log('createMap', lat, lon)
            let zoom = 3// by default, zoomed out
            let showPopupOnOpen = false
            if (lat && lon) {
                showPopupOnOpen = true
                zoom = 5// if location is set, zoom in a bit
            }
            lat = safeFloat(lat, 50.0)
            lon = safeFloat(lon, 0.0)
            if (RED._cron_plus_debug) console.log('lat/lon', lat, lon)
            selectedLocation = window.L.latLng(lat, lon)
            if (RED._cron_plus_debug) console.log('selectedLocation', selectedLocation.lat, selectedLocation.lng)

            // create leaflet map
            map = window.L.map('ui-scheduler-map', {
                zoomControl: true,
                center: selectedLocation, // [selectedLocation.lat,selectedLocation.lng],
                zoom
            })
            mapPopup = window.L.popup()

            map.on('click', function (e) {
                if (RED._cron_plus_debug) console.log(e)
                const normaliseLat = function (x) {
                    while (x > 90.0 || x < -90.0) {
                        if (x > 90.0) { x = -(90.0 - (x - 90)) }
                        if (x < -90.0) { x = (90.0 - ((-x) - 90)) }
                    }
                    return x
                }
                const normaliseLng = function (x) {
                    while (x > 180.0 || x < -180.0) {
                        if (x > 180.0) { x = -(180.0 - (x - 180)) }
                        if (x < -180.0) { x = (180.0 - ((-x) - 180)) }
                    }
                    return x
                }
                selectedLocation = {}
                selectedLocation.lat = normaliseLat(e.latlng.lat)
                selectedLocation.lng = normaliseLng(e.latlng.lng)
                const content =
                    '<div><span>Lat:</span> <span>' + selectedLocation.lat + '</span></div>' +
                    '<div><span>Lon:</span> <span>' + selectedLocation.lng + '</span></div>'
                showMapPopup(content, e.latlng.lat, e.latlng.lng, map)
            })

            function showMapPopup (content, lat, lon, map) {
                mapPopup
                    .setLatLng([lat, lon])
                    .setContent(content)
                    .openOn(map)
            }

            // add a base layer
            const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
            const layer = L.tileLayer(tileUrl, {})
            layer.addTo(map)
            // add cartodb layer with one sublayer
            cartodb.createLayer(map, {
                user_name: 'node-red',
                type: 'namedmap',
                options: {
                    named_map: {
                        name: 'node-red@ui-scheduler',
                        params: {
                            color: '#5CA2D1'
                        },
                        layers: [{}]
                    }
                }
            })
                .addTo(map)
                .done(function (layer) {
                    layer.setInteraction(true)
                    if (showPopupOnOpen) {
                        const content =
                            '<div><span>Lat:</span> <span>' + selectedLocation.lat + '</span></div>' +
                            '<div><span>Lon:</span> <span>' + selectedLocation.lng + '</span></div>'
                        showMapPopup(content, selectedLocation.lat, selectedLocation.lng, map)
                    }

                    // eslint-disable-next-line no-unused-vars
                    layer.on('featureClick', function (e, latlng, pos, data, layer) {
                        if (RED._cron_plus_debug) console.log('click', latlng, data)
                    })
                    $('#ui-scheduler-map-dialog').dialog('option', 'position', { my: 'center', at: 'center', of: window })
                })
        }

        function showMap (srcInput) {
            $('#ui-scheduler-map-dialog').dialog('open')
            if (navigator.onLine === true) {
                $('.ui-scheduler-map-not-loaded').show()
                $('.ui-scheduler-map-loading').hide()
                $('#ui-scheduler-map').hide()
                const proto = location.protocol === 'https:' ? location.protocol : 'http:'
                checkLoadJsCssFile(proto + '//libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css', 'css', function () {
                    checkLoadJsCssFile(proto + '//libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.uncompressed.js', 'js', function () {
                        createMap(srcInput)
                    })
                })
            } else {
                $('.ui-scheduler-map-not-loaded').show()
                $('.ui-scheduler-map-loading').hide()
                $('#ui-scheduler-map').hide()
            }
        }

        function updateEditorLayout () {
            onSchedulesExpandCompress()

            if (RED._cron_plus_debug) console.log('ui-scheduler-updateEditorLayout')
            const scheduleList = $('#node-ui-scheduler-tab-static-schedules')
            const scheduleListFullScreen = scheduleList.css('position') === 'fixed' || document.fullscreenElement
            if (scheduleListFullScreen) {
                return // don't update layout if schedules are fullscreen
            }
            const dlg = $('#dialog-form')
            let height = dlg.height() - 5
            const expandRow = dlg.find('.form-row-auto-height')
            if (expandRow && expandRow.length) {
                const childRows = dlg.find('.form-row:not(.form-row-auto-height)')
                for (let i = 0; i < childRows.size(); i++) {
                    const cr = $(childRows[i])
                    if (cr.is(':visible')) { height -= cr.outerHeight(true) }
                }
                expandRow.css('height', height + 'px')
            }
            const show = $('#node-input-defaultLocation').typedInput('type') === 'default' || !$('#node-input-defaultLocation').typedInput('type')
            $('.ui-scheduler-node-input-option-location-div').toggleClass('ui-scheduler-hide-per-location', !show)
        }

        $.widget('custom.combobox', {
            _create: function () {
                const that = this
                this.input = this.element
                this.input.addClass('red-ui-typedInput-input')
                this.elementDiv = $(this.input).wrap('<div>').parent().addClass('red-ui-typedInput-input-wrap')
                this.uiSelect = $(this.elementDiv).wrap($('<div>', { style: this.options.style })).parent()

                const attrStyle = this.options.style || this.element.attr('style')
                this.uiWidth = this.input.outerWidth()
                this.input.css('paddingLeft', 5)

                let m
                if ((m = /width\s*:\s*(calc\s*\(.*\)|\d+(%|px))/i.exec(attrStyle)) !== null) {
                    this.input.css('width', 'calc(100% - 4px)')
                    this.uiSelect.width(m[1])
                    this.uiWidth = null
                } else {
                    this.uiSelect.width(this.uiWidth)
                }

                ['Right', 'Left'].forEach(function (d) {
                    const m = that.element.css('margin' + d)
                    that.uiSelect.css('margin' + d, m)
                    that.input.css('margin' + d, 1)
                })

                this.uiSelect.addClass('red-ui-typedInput-container')

                this.input.on('change', function () {
                    that.validate()
                })

                this.button = $('<button tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block;width: 20px"><span class="red-ui-typedInput-option-caret"><i class="red-ui-typedInput-icon fa fa-caret-down"></i></span></button>').appendTo(this.uiSelect)
                // this.buttonLabel = $('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.button);
                this.button.on('click', function (event) {
                    event.preventDefault()
                    event.stopPropagation()
                    that._showDropdownMenu()
                }).on('keydown', function (evt) {
                    if (evt.keyCode === 40 /* down */) {
                        that._showDropdownMenu()
                    }
                    evt.stopPropagation()
                }).on('blur', function () {
                    that.uiSelect.removeClass('red-ui-typedInput-focus')
                }).on('focus', function () {
                    that.uiSelect.addClass('red-ui-typedInput-focus')
                })
                this.menu = this._createMenu(this.options.menu)
            },
            _createMenu: function (options) {
                if (RED._cron_plus_debug) console.log('combobox -> _createMenu  options:', options)
                const that = this
                this.disarmClick = false
                options = options || {}
                const menu = $('<div>').addClass('red-ui-typedInput-options red-ui-editor-dialog')
                const callback = options.options ? options.options.callback : null
                const beforeSelect = options.options ? options.options.beforeSelect : null
                const menuItems = options.menu || []
                menuItems.forEach(function (opt) {
                    if (typeof opt === 'string') {
                        opt = { value: opt, label: opt }
                    }
                    const op = $('<a href="#"></a>').attr('value', opt.value).appendTo(menu)
                    if (opt.label) {
                        op.text(opt.label)
                    }
                    if (opt.title) {
                        op.prop('title', opt.title)
                    }
                    if (opt.icon) {
                        if (opt.icon.indexOf('<') === 0) {
                            $(opt.icon).prependTo(op)
                        } else if (opt.icon.indexOf('/') !== -1) {
                            $('<img>', { src: opt.icon, style: 'margin-right: 4px; height: 18px;' }).prependTo(op)
                        } else {
                            $('<i>', { class: 'red-ui-typedInput-icon ' + opt.icon }).prependTo(op)
                        }
                    } else {
                        op.css({ paddingLeft: '18px' })
                    }
                    if (!opt.icon && !opt.label) {
                        op.text(opt.value)
                    }

                    op.on('click', function (event) {
                        event.preventDefault()
                        event.stopPropagation()
                        let cancel = false
                        if (beforeSelect) {
                            cancel = beforeSelect(opt)
                        }
                        if (!cancel) {
                            if (callback) {
                                that.value(callback(opt.value))
                            } else {
                                that.value(opt.value)
                            }
                        }

                        that._hideMenu(menu)
                    })
                })
                menu.css({ display: 'none' })
                menu.appendTo(document.body)

                menu.on('keydown', function (evt) {
                    if (evt.keyCode === 40/* down */) {
                        evt.preventDefault()
                        $(this).children(':focus').next().trigger('focus')
                    } else if (evt.keyCode === 38/* up */) {
                        evt.preventDefault()
                        $(this).children(':focus').prev().trigger('focus')
                    } else if (evt.keyCode === 27/* escape */) {
                        evt.preventDefault()
                        that._hideMenu(menu)
                    }
                    evt.stopPropagation()
                })
                return menu
            },
            _showDropdownMenu: function () {
                if (this.menu) {
                    this.menu.css({
                        minWidth: this.uiSelect.width()
                    })
                    this._showMenu(this.menu, this.button)
                }
            },
            _hideMenu: function (menu) {
                $(document).off('mousedown.red-ui-typedInput-close-property-select')
                menu.hide()
                menu.css({
                    height: 'auto'
                })
                this.input.trigger('focus')
                // this.button.trigger("focus");
            },
            _showMenu: function (menu, relativeTo) {
                if (this.disarmClick) {
                    this.disarmClick = false
                    return
                }
                const that = this
                // var pos = relativeTo.offset();
                // var height = relativeTo.height();
                const pos = this.uiSelect.offset()
                const height = this.uiSelect.height()
                const menuHeight = menu.height()
                const menuWidth = menu.width()
                let top = (height + pos.top)
                let left = pos.left
                if (left + menuWidth > $(window).width()) {
                    left -= (left + menuWidth) - $(window).width() + 5
                }
                if (top + menuHeight > $(window).height()) {
                    top -= (top + menuHeight) - $(window).height() + 5
                }
                if (top < 0) {
                    menu.height(menuHeight + top)
                    top = 0
                }
                menu.css({
                    top: top + 'px',
                    left: (left) + 'px'
                })
                menu.slideDown(100)
                this._delay(function () {
                    that.uiSelect.addClass('red-ui-typedInput-focus')
                    $(document).on('mousedown.red-ui-typedInput-close-property-select', function (event) {
                        if (!$(event.target).closest(menu).length) {
                            that._hideMenu(menu)
                        }
                        if ($(event.target).closest(relativeTo).length) {
                            that.disarmClick = true
                            event.preventDefault()
                        }
                    })
                })
            },
            _destroy: function () {
                if (this.menu) {
                    this.menu.remove()
                }
                this.button.remove()
                this.element.unwrap()
                this.element.unwrap()
                this.input.removeClass('red-ui-typedInput-input')
            },
            value: function (value) {
                const that = this
                if (!arguments.length) {
                    return that.input.val()
                } else {
                    that.input.val(value)
                    that.validate()
                }
            },
            validate: function () {
                let ok
                const value = this.value()
                const _validate = this.options.validate// || this.validate;
                if (!_validate || typeof _validate !== 'function') {
                    ok = true
                } else {
                    ok = _validate(value)
                }
                if (ok) {
                    this.uiSelect.removeClass('input-error')
                } else {
                    this.uiSelect.addClass('input-error')
                }
                return ok
            },
            showMenu: function () {
                this.button.show()
            },
            hideMenu: function () {
                this.button.hide()
            },
            show: function () {
                this.uiSelect.show()
            },
            hide: function () {
                this.uiSelect.hide()
            }
        })

        RED.nodes.registerType('ui-scheduler', {
            category: RED._('@flowfuse/node-red-dashboard/ui-base:ui-base.label.category'),
            color: RED._('@flowfuse/node-red-dashboard/ui-base:ui-base.colors.light'),
            defaults: {
                name: { value: 'scheduler' },
                group: { type: 'ui-group', required: true },
                order: { value: 0 },
                label: { value: 'Scheduler' },
                width: {
                    value: 6,
                    validate: function (v) {
                        const width = v || 0
                        const currentGroup = $('#node-input-group').val() || this.group
                        const groupNode = RED.nodes.node(currentGroup)
                        const valid = !groupNode || +width >= 0
                        $('#node-input-size').toggleClass('input-error', !valid)
                        return valid
                    }
                },
                height: { value: 1 },
                // FUTURE config: { type: "ui-scheduler Config" },
                outputField: { value: 'payload' },
                timeZone: { value: '' },
                use24HourFormat: { value: false },
                useNewTimePicker: { value: false },
                storeName: { value: 'NONE' },
                commandResponseMsgOutput: { value: 'fanOut' },
                defaultLocation: { value: '' },
                defaultLocationType: { value: '' },
                sendStateInterval: { value: 60 },
                sendActiveState: { value: true },
                sendInactiveState: { value: true },
                topics: { value: ['Topic 1'] },
                customPayloads: {
                    value: [{ value: '', label: '', id: '' }],
                    validate: function (v) {
                        const unique = new Set(v.map(o => o.value))
                        return v.length === unique.size
                    }
                },

                outputs: { value: 2 },
                options: {
                    value: [],
                    validate: function (value) {
                        const dupCheck = {}
                        if (value.length) {
                            for (let i = 0; i < value.length; i++) {
                                if (!value[i].name && value[i].topic) {
                                    value[i].name = value[i].topic
                                }
                                if (!value[i].name) {
                                    console.warn('ui-scheduler: validation error - schedule name missing')
                                    $('#node-input-option-container > li:nth-child(' + (i + 1) + ')  .node-input-option-name').addClass('input-error')
                                    return false
                                } else {
                                    $('#node-input-option-container > li:nth-child(' + (i + 1) + ')  .node-input-option-name').removeClass('input-error')
                                }
                                if (dupCheck[value[i].name]) {
                                    console.warn("ui-scheduler: validation error - duplicate schedule named '" + value[i].name + "'")
                                    $('#node-input-option-container > li:nth-child(' + (i + 1) + ')  .node-input-option-name').addClass('input-error')
                                    return false
                                } else {
                                    $('#node-input-option-container > li:nth-child(' + (i + 1) + ')  .node-input-option-name').removeClass('input-error')
                                }
                                dupCheck[value[i].name] = true
                                if (!value[i].expressionType || value[i].expressionType === 'cron') {
                                    if (!value[i].expression) {
                                        console.warn('ui-scheduler: validation error - expression missing')
                                        // $("#node-input-option-container > li:nth-child(" + (i+1) + ")  .node-input-option-expressionType").addClass("input-error");
                                        return false
                                    }
                                } else if (value[i].expressionType === 'solar') {
                                    if (value[i].solarType !== 'all' && value[i].solarType !== 'selected') {
                                        console.warn("ui-scheduler: validation error - solarType is not 'all' or 'selected'")
                                        // $("#node-input-option-container > li:nth-child(" + (i+1) + ")  .node-input-option-solarType").addClass("input-error");
                                        return false
                                    }
                                    if (value[i].solarType === 'selected' && !value[i].solarEvents) {
                                        console.warn('ui-scheduler: validation error - solarEvents missing')
                                        return false
                                    }
                                }
                            }
                        }
                        return true
                    },
                    required: true
                }
            },
            inputs: 1,
            outputs: 1,
            icon: 'font-awesome/fa-clock-o',
            paletteLabel: 'scheduler',
            label: function () { return this.name || (~this.label.indexOf('{' + '{') ? null : this.label) || 'Scheduler' },
            outputLabels: function (index) {
                const node = this
                const fanOut = node.commandResponseMsgOutput === 'fanOut'
                const hasScheduleOutputPin = !!((node.commandResponseMsgOutput === 'output2' || fanOut))
                const cmdOutputPinIndex = 0
                if (!fanOut && !hasScheduleOutputPin) return 'All messages and events'
                if (!fanOut && hasScheduleOutputPin && index === 1) return 'Static and Dynamic schedule messages'
                if (index === cmdOutputPinIndex) return 'Command responses only'
                const item = node.topics && node.topics[index - 1]
                if (item) return item
            },

            oneditprepare: function () {
                console.log(RED)

                if (RED._cron_plus_debug) { console.log('oneditprepare - ui-scheduler') }
                const node = this
                const dupCheck = {}
                const selectedLocationInput = null

                if (RED.nodes.subflow(this.z)) {
                    // change inputs from hidden to text & display them
                    $('#node-input-width').attr('type', 'text')
                    $('#node-input-height').attr('type', 'text')
                    $('div.form-row.nr-db-ui-element-sizer-row').hide()
                    $('div.form-row.nr-db-ui-manual-size-row').show()
                } else {
                    // not in a subflow, use the elementSizer
                    $('div.form-row.nr-db-ui-element-sizer-row').show()
                    $('div.form-row.nr-db-ui-manual-size-row').hide()
                    $('#node-input-size').elementSizer({
                        width: '#node-input-width',
                        height: '#node-input-height',
                        group: '#node-input-group'
                    })
                }

                node.commandResponseMsgOutput = ['output1', 'output2', 'fanOut'].indexOf(node.commandResponseMsgOutput) >= 0 ? node.commandResponseMsgOutput : 'output1'

                // eslint-disable-next-line no-undef
                initMap()

                // inherit/upgrade deprecated properties from config
                const hasStoreNameProperty = hasProperty(node, 'storeName') && typeof node.storeName === 'string'
                if (hasStoreNameProperty) {
                    // not an upgrade - accept node.storeName property value
                }

                // populate store names
                const currentStore = node.storeName || 'NONE'
                $('#node-input-storeName').empty()
                $('#node-input-storeName').append('<option value="NONE">None: Don\'t persist state</option>')
                $('#node-input-storeName').append('<option value="local_file_system">File: local file system</option>')
                RED.settings.context.stores.forEach(function (item) {
                    const defaultStore = hasProperty(RED.settings, 'context') ? RED.settings.context.default : 'NONE'
                    if (!item) {
                        return // skip empty store names
                    }
                    let name = item
                    if (item === defaultStore) {
                        name += ' (default)'
                    }
                    const opt = $(`<option value="${item}">${'Node Context: ' + name}</option>`)
                    $('#node-input-storeName').append(opt)
                })

                // if the store does not exist, add it to the dropdown and select it (appended with the text "NOT AVAILABLE!")
                if (currentStore !== 'NONE' && currentStore !== 'local_file_system' && RED.settings.context.stores.indexOf(currentStore) === -1) {
                    const opt = $(`<option selected disabled style="color: var(--red-ui-text-color-error) !important;" value="${currentStore}">${'Node Context: ' + currentStore + ' (INVALID)'}</option>`)
                    $('#node-input-storeName').append(opt)
                } else {
                    // select the current option
                    $('#node-input-storeName').val(currentStore)
                }

                // create common location typed input
                $('#node-input-defaultLocation').typedInput({
                    default: 'default',
                    types: [
                        {
                            value: 'default',
                            label: 'Location per schedule',
                            hasValue: false,
                            icon: 'fa fa-map-marker'
                        },
                        {
                            value: 'fixed',
                            label: 'Fixed Location',
                            icon: 'fa fa-map-pin',
                            expand: function () {
                                // eslint-disable-next-line no-undef
                                showMap($('#node-input-defaultLocation'))
                            },
                            validate: function (v, opt) { return !!v && v.length >= 3 }
                        },
                        'env'
                    ]
                })
                $('#node-input-defaultLocation').typedInput('type', node.defaultLocationType || 'default')
                $('#node-input-defaultLocation').typedInput('value', node.defaultLocation || '')
                $('#node-input-defaultLocation').on('change', function () {
                    const show = $('#node-input-defaultLocation').typedInput('type') === 'default' || !$('#node-input-defaultLocation').typedInput('type')
                    $('.ui-scheduler-node-input-option-location-div').toggleClass('ui-scheduler-hide-per-location', !show)
                })

                // Ensure customPayloads array exists
                if (!this.customPayloads) {
                    this.customPayloads = []
                }

                // Validate uniqueness of 'value' properties
                const uniqueValues = new Set(this.customPayloads.map(o => o.value))
                if (this.customPayloads.length === uniqueValues.size) {
                    $('#valWarning').hide()
                } else {
                    $('#valWarning').show()
                }

                function generateCustomPayload (i, customPayload) {
                    const container = $('<li/>', {
                        style: 'background: var(--red-ui-secondary-background, #fff); margin:0; padding:8px 0px 0px; border-bottom: 1px solid var(--red-ui-form-input-border-color, #ccc);'
                    })

                    const row = $('<div/>').appendTo(container)

                    // Drag handle
                    $('<i/>', {
                        class: 'node-input-customPayload-handle fa fa-bars',
                        style: 'color: var(--red-ui-form-text-color, #eee); cursor:move; margin-left:3px;'
                    }).appendTo(row)

                    // Value input
                    const valueInput = $('<input/>', {
                        class: 'node-input-customPayload-value',
                        type: 'text',
                        style: 'margin-left:7px; width:calc(50% - 32px);',
                        placeholder: 'Value',
                        value: JSON.stringify(customPayload.value)
                    }).appendTo(row).typedInput({
                        default: customPayload.type || 'str',
                        types: ['str', 'num', 'json']
                    })

                    // Label input
                    $('<input/>', {
                        class: 'node-input-customPayload-label',
                        type: 'text',
                        style: 'margin-left:7px; width:calc(50% - 32px);',
                        placeholder: 'Label',
                        value: customPayload.label
                    }).appendTo(row)

                    // Store the unique ID invisibly
                    const payloadId = customPayload.id || generateUniqueId()
                    container.data('id', payloadId)

                    // Delete button
                    const deleteButton = $('<a/>', {
                        href: '#',
                        class: 'editor-button editor-button-small',
                        style: 'margin-top:7px; margin-left:5px;'
                    }).appendTo($('<span/>', {
                        style: 'float:right; margin-right:8px;'
                    }).appendTo(row))
                    $('<i/>', {
                        class: 'fa fa-remove'
                    }).appendTo(deleteButton)

                    deleteButton.click(function () {
                        container.css({
                            background: 'var(--red-ui-secondary-background-inactive, #fee)'
                        })
                        container.fadeOut(300, function () {
                            $(this).remove()
                        })
                    })

                    // Append to container
                    $('#node-input-customPayload-container').append(container)
                }

                // Add new custom payload
                $('#node-input-add-customPayload').click(function () {
                    generateCustomPayload($('#node-input-customPayload-container').children().length + 1, {})
                    $('#node-input-customPayload-container-div').scrollTop($('#node-input-customPayload-container-div').get(0).scrollHeight)
                })

                // Generate custom payloads for existing data
                this.customPayloads.forEach((customPayload, i) => {
                    generateCustomPayload(i + 1, customPayload)
                })

                // Make the list sortable
                $('#node-input-customPayload-container').sortable({
                    axis: 'y',
                    handle: '.node-input-customPayload-handle',
                    cursor: 'move'
                })

                // create the popup dialog for the cron builder
                $('#ui-scheduler-expression-builder-dialog').dialog({
                    autoOpen: false,
                    height: 300,
                    width: 480,
                    minWidth: 400,
                    maxWidth: 600,
                    modal: true,
                    buttons: {
                        Cancel: function () {
                            $('#ui-scheduler-expression-builder-dialog').dialog('close')
                        },
                        OK: function () {
                            const val = $('#ui-scheduler-expression-builder').data('cronBuilder').getExpression()
                            const expressionField = $('#ui-scheduler-expression-builder-dialog').data('opener')
                            if (expressionField && expressionField.length) {
                                expressionField.combobox('value', val || '')
                                // expressionField.focus();
                            }
                            $('#ui-scheduler-expression-builder-dialog').dialog('close')
                        }
                    },
                    show: {
                        effect: 'blind',
                        duration: 500
                    },
                    // eslint-disable-next-line no-unused-vars
                    open: function (event) {
                        // $(this).css('padding', '0px 0px 0px 0px');
                        $('.ui-dialog-buttonpane').find('button:contains("OK")').addClass('primary')
                        $('#ui-scheduler-expression-builder .cron-period-select').change()// cause cronBuilder UI to update
                    },
                    close: function () {
                        const expressionField = $('#ui-scheduler-expression-builder-dialog').data('opener')
                        if (expressionField && expressionField.data('customCombobox') && expressionField.data('customCombobox').input) {
                            // expressionField.combobox("value", val || "");
                            expressionField.data('customCombobox').input.focus()
                        }
                    },
                    hide: {
                        effect: 'explode',
                        duration: 500
                    }
                })

                // build cron builder
                if (!$('#ui-scheduler-expression-builder').data('cronBuilder')) {
                    $('#ui-scheduler-expression-builder').cronBuilder()
                }

                function StringBuilder () {
                    const strings = []
                    return {
                        push: function (value) {
                            if (value) {
                                if (value instanceof StringBuilder) {
                                    strings.push(...value.strings)
                                } else if (Array.isArray(value)) {
                                    strings.push(...value)
                                } else {
                                    strings.push(value)
                                }
                            }
                            return this
                        },
                        clear: function () {
                            strings.length = 0
                            return this
                        },
                        toString: function (joiner = '\n') {
                            return strings.join(joiner)
                        }
                    }
                }

                function drawDynamicSchedulesTable (nodeId, table, spinner, options, callback) {
                    if (RED._cron_plus_debug) console.log('drawDynamicSchedulesTable...')
                    const $table = $(table)
                    const $spinner = $(spinner)
                    $table.hide()
                    $spinner.show()
                    $table.empty()
                    $.ajax({
                        type: 'POST',
                        url: 'ui-scheduler/' + nodeId + '/getDynamic',
                        headers: {
                            Accept: 'application/json',
                            'Content-Type': 'application/json'
                        },
                        dataType: 'json',
                        data: '{}' // dummy data
                    })
                        .done(function (response) {
                            if (RED._cron_plus_debug) console.log('ui-scheduler/' + nodeId + '/getDynamic => response:', response)

                            options = options || {}
                            if (options.width) $table.width(options.width)
                            if (options.height) $table.width(options.height)
                            if (options.class) $table.addClass(options.class)

                            if (!response || !response.length) {
                                $spinner.hide()
                                $table.show()
                                $('<div/>' + (options.emptyMessage || 'no data') + '<div>').css({ padding: '12px', 'font-size': '24px' }).appendTo($table)
                                return
                            }

                            const itemsToHTML = (items) => {
                                const styleBuilder = new StringBuilder()
                                styleBuilder.push('<' + 'style' + '>')
                                styleBuilder.push('    .accordion-container{')
                                styleBuilder.push('        position: relative;')
                                styleBuilder.push('        width: 100%;')
                                styleBuilder.push('        height: auto;')
                                styleBuilder.push('    }')
                                styleBuilder.push('    .accordion-container .accordion-item{')
                                styleBuilder.push('        position: relative;')
                                styleBuilder.push('        width: 100%;')
                                styleBuilder.push('        height: auto;')
                                styleBuilder.push('        background-color: var(--red-ui-form-button-background);')
                                styleBuilder.push('    }')
                                styleBuilder.push('    .accordion-container .accordion-item > a{')
                                styleBuilder.push('        display: block;')
                                styleBuilder.push('        padding: 10px 15px;')
                                styleBuilder.push('        text-decoration: none;')
                                styleBuilder.push('        color: var(--red-ui-primary-text-color);')
                                styleBuilder.push('        font-weight: 600;')
                                styleBuilder.push('        border-bottom: 1px solid var(--red-ui-primary-border-color);')
                                styleBuilder.push('        -webkit-transition:all 0.2s linear;')
                                styleBuilder.push('        -moz-transition:all 0.2s linear;')
                                styleBuilder.push('        transition:all 0.2s linear;')
                                styleBuilder.push('    }')
                                styleBuilder.push('    .accordion-container .accordion-item > a.active{')
                                styleBuilder.push('        background-color: var(--red-ui-form-input-focus-color)')
                                styleBuilder.push('        color: var(--red-ui-primary-text-color);')
                                styleBuilder.push('    }')
                                styleBuilder.push('    .accordion-container .accordion-item > div{')
                                styleBuilder.push('        background-color: var(--red-ui-primary-background);')
                                styleBuilder.push('        border-bottom: 1px solid var(--red-ui-primary-border-color);')
                                styleBuilder.push('        display:none;')
                                styleBuilder.push('    }')
                                styleBuilder.push('    .accordion-container .accordion-item > div {')
                                styleBuilder.push('        padding: 10px 15px;')
                                styleBuilder.push('        margin: 0;')
                                styleBuilder.push('        color: var(--red-ui-primary-text-color);')
                                styleBuilder.push('    }')
                                styleBuilder.push('    div.accordion-container a > div {')
                                styleBuilder.push('        display: flex;')
                                styleBuilder.push('        flex-flow: row wrap;')
                                styleBuilder.push('        justify-content: space-around;')
                                styleBuilder.push('        padding: 0;')
                                styleBuilder.push('        margin: 0;')
                                styleBuilder.push('    }')
                                styleBuilder.push('    .accordion-container a > div > name,')
                                styleBuilder.push('    .accordion-container a > div > topic,')
                                styleBuilder.push('    .accordion-container a > div > desc{')
                                styleBuilder.push('        flex-grow: 2;')
                                styleBuilder.push('        flex: 2 0 5px;')
                                styleBuilder.push('        white-space: break-word;')
                                styleBuilder.push('        word-break: break-all;')
                                styleBuilder.push('        overflow: hidden;')
                                styleBuilder.push('        text-overflow: ellipsis;')
                                styleBuilder.push('        min-width: 0;')
                                styleBuilder.push('        padding: 0px 6px')
                                styleBuilder.push('    }')
                                styleBuilder.push('    .accordion-container a > div > name{')
                                styleBuilder.push('        flex-grow: 3;')
                                styleBuilder.push('    }')
                                styleBuilder.push('    .accordion-container a > div > topic{')
                                styleBuilder.push('        flex-grow: 3;')
                                styleBuilder.push('    }')
                                styleBuilder.push('    .accordion-container a > div > desc{')
                                styleBuilder.push('        flex-grow: 4;')
                                styleBuilder.push('    }')
                                styleBuilder.push('    .accordion-container  a .accordion-title > i {')
                                styleBuilder.push('        flex: 0 1 20px;')
                                styleBuilder.push('        -webkit-order: 0;')
                                styleBuilder.push('        -ms-flex-order: 0;')
                                styleBuilder.push('        order: 0;')
                                styleBuilder.push('        -webkit-flex: 0 1 auto;')
                                styleBuilder.push('        -ms-flex: 0 1 auto;')
                                styleBuilder.push('        -webkit-align-self: auto;')
                                styleBuilder.push('        -ms-flex-item-align: auto;')
                                styleBuilder.push('        align-self: auto;')
                                styleBuilder.push('    }')
                                styleBuilder.push('    .accordion-container a.active .accordion-title > :not(:first-child,:last-child){')
                                styleBuilder.push('        display: none;')
                                styleBuilder.push('    }')
                                styleBuilder.push('    .accordion-container a.active .accordion-title > name {')
                                styleBuilder.push('        flex: 2;')
                                styleBuilder.push('    }')
                                styleBuilder.push('    .accordion-container .accordion-content code {')
                                styleBuilder.push('        color: var(--red-ui-text-color-code);')
                                styleBuilder.push('    }')
                                styleBuilder.push('<' + '/style' + '>')

                                const scriptBuilder = new StringBuilder()
                                scriptBuilder.push('<' + 'script' + '>')
                                scriptBuilder.push('$(".accordion-container a").on("click", function() {')
                                scriptBuilder.push('    if ($(this).hasClass("active")) {')
                                scriptBuilder.push('    $(this).removeClass("active");')
                                scriptBuilder.push('    $(this).siblings("div").slideUp(200);')
                                scriptBuilder.push('    } else {')
                                scriptBuilder.push('    $(this).addClass("active");')
                                scriptBuilder.push('    $(this).siblings("div").slideDown(200);')
                                scriptBuilder.push('    }')
                                scriptBuilder.push('    $(".accordion-container a:not(.active) i")')
                                scriptBuilder.push('        .removeClass("fa-minus")')
                                scriptBuilder.push('        .addClass("fa-plus");')
                                scriptBuilder.push('    $(".accordion-container a.active i")')
                                scriptBuilder.push('        .removeClass("fa-plus")')
                                scriptBuilder.push('        .addClass("fa-minus");')
                                scriptBuilder.push('});')
                                scriptBuilder.push('<' + '/script' + '>')

                                const htmlBuilder = new StringBuilder()
                                htmlBuilder.push('<div class="accordion-container">')
                                items.forEach(item => {
                                    htmlBuilder.push('  <div class="accordion-item">')
                                    htmlBuilder.push('    <a href="#">')
                                    htmlBuilder.push('      <div class="accordion-title">')
                                    htmlBuilder.push(`        <name>${item.config.name}</name>`)
                                    htmlBuilder.push(`        <topic>${item.config.topic}</topic>`)
                                    htmlBuilder.push(`        <desc>${item.status.nextDescription}</desc>`)
                                    htmlBuilder.push('        <i class="fa fa-plus"></i>')
                                    htmlBuilder.push('      </div> ')
                                    htmlBuilder.push('    </a>')
                                    htmlBuilder.push('    <div class="accordion-content">')
                                    htmlBuilder.push('      <p>')
                                    htmlBuilder.push('        <code>config:</code>')
                                    htmlBuilder.push('        <code>')
                                    htmlBuilder.push(`          ${JSON.stringify(item.config, null, 1).replace(/\n/g, '')}`)
                                    htmlBuilder.push('        </code>')
                                    htmlBuilder.push('      </p>')
                                    htmlBuilder.push('      <p>')
                                    htmlBuilder.push('        <code>status:</code>')
                                    htmlBuilder.push('        <code>')
                                    htmlBuilder.push(`          ${JSON.stringify(item.status, null, 1).replace(/\n/g, '')}`)
                                    htmlBuilder.push('        </code>')
                                    htmlBuilder.push('      </p>')
                                    htmlBuilder.push('    </div>')
                                    htmlBuilder.push('  </div>')
                                })
                                htmlBuilder.push('</div>')
                                const stringBuilder = new StringBuilder()
                                stringBuilder.push(styleBuilder)
                                stringBuilder.push(htmlBuilder)
                                stringBuilder.push(scriptBuilder)
                                return stringBuilder.toString()
                            }

                            // tidy up date for display
                            const data = response.map(function (e, i) {
                                e.item = i + 1
                                if (e.type) {
                                    e.payloadType = e.type
                                    delete e.type
                                }
                                if (e.payloadType === 'default') e.payload = null

                                if (e.payload && isObject(e.payload)) {
                                    try {
                                        e.payload = JSON.stringify(e.payload, undefined, 2)
                                    } catch (error) {
                                        e.payload = typeof e.payload
                                    }
                                }
                                return e
                            })

                            $table.html(itemsToHTML(data))
                            $table.show()
                            $spinner.hide()
                            if (callback) callback()
                        })
                        .fail(function (jqXHR, textStatus, errorThrown) {
                            if (callback) callback(errorThrown)
                            console.error(jqXHR, textStatus, errorThrown)
                        })
                }

                const dnRepositionResize = function () {
                    const w = ($(document).width() < 1025) ? '95%' : '60%'
                    if (RED._cron_plus_debug) console.log('dialog-open-drawDynamicSchedulesTable done - should now center and resize width', w)
                    $('#ui-scheduler-dynamic-nodes-dialog').dialog('option', 'width', w)
                    $('#ui-scheduler-dynamic-nodes-dialog').dialog('option', 'position', { my: 'center', at: 'center', of: window })
                }

                $('#ui-scheduler-dynamic-nodes-dialog').dialog({
                    autoOpen: false,
                    height: 630,
                    minHeight: 400,
                    minWidth: 300,
                    modal: true,
                    buttons: {
                        Refresh: function () {
                            const nodeId = $('#ui-scheduler-dynamic-nodes-dialog').data('_cron_node_id')
                            drawDynamicSchedulesTable(nodeId, '#ui-scheduler-dynamic-nodes-table-placeholder', '#ui-scheduler-dynamic-nodes-loader', {}, dnRepositionResize)
                        },
                        Close: function () {
                            $('#ui-scheduler-dynamic-nodes-dialog').dialog('close')
                        }
                    },
                    // eslint-disable-next-line no-unused-vars
                    open: function (event) {
                        $(this).css('padding', '0px 0px 0px 0px')
                        $('.ui-dialog-buttonpane').find('button:contains("Close")').addClass('primary')
                        const nodeId = $('#ui-scheduler-dynamic-nodes-dialog').data('_cron_node_id')
                        dnRepositionResize()
                        drawDynamicSchedulesTable(nodeId, '#ui-scheduler-dynamic-nodes-table-placeholder', '#ui-scheduler-dynamic-nodes-loader', dnRepositionResize)
                    },
                    show: {
                        effect: 'fade',
                        duration: 250
                    },
                    hide: {
                        effect: 'fade',
                        duration: 250
                    }
                })

                $('#ui-scheduler-dynamic-nodes-dialog').data('_cron_node_id', node.id)
                dnRepositionResize()

                let tzData
                $.ajax({
                    type: 'POST',
                    url: 'ui-scheduler/0/tz',
                    headers: {
                        Accept: 'application/json',
                        'Content-Type': 'application/json'
                    },
                    dataType: 'json',
                    data: '{}' // dummy data
                })
                    .done(function (data) {
                        tzData = data
                        $('#node-input-timeZone').autocomplete({
                            source: function (request, response) {
                                const matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), 'i')
                                response($.map(tzData, function (item) {
                                    if (item && item.tz) {
                                        const label = (item.code ? item.code + ', ' : '') + item.tz + ' (UTC: ' + item.UTCOffset + ', DST: ' + item.UTCDSTOffset + ')'
                                        if (label && (!request.term || matcher.test(label))) {
                                            return {
                                                label,
                                                value: item
                                            }
                                        }
                                    }
                                }))
                            },
                            minLength: 1,
                            open: function () {
                                $(this).removeClass('ui-corner-all').addClass('ui-corner-top')
                            },
                            close: function () {
                                $(this).removeClass('ui-corner-top').addClass('ui-corner-all')
                            },
                            focus: function (event, ui) {
                                event.preventDefault()
                                $('#node-input-timeZone').val(ui.item.label)
                            },
                            select: function (event, ui) {
                                event.preventDefault()
                                this.value = ui.item.value.tz
                            }
                        })
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        console.error(jqXHR, textStatus, errorThrown)
                    })

                const formatDateTimeWithTZ = function (date, tz) {
                    if (!date) {
                        return ''
                    }
                    let dateString
                    const o = {
                        timeZone: tz || undefined,
                        timeZoneName: 'short',
                        hour12: false,
                        year: 'numeric',
                        month: 'short',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }
                    try {
                        dateString = new Intl.DateTimeFormat('default', o).format(new Date(date))
                    } catch (error) {
                        dateString = 'Error. Check timezone setting'
                    }
                    return dateString
                }

                const makeSolarChoice = function (value, label, tooltip) {
                    return {
                        label,
                        value: value || label,
                        title: tooltip,
                        multiple: true
                    }
                }

                const solarChoices = [
                    makeSolarChoice('nightEnd', 'night end / astronomical dawn', 'night ends, astronomical twilight starts (-18)'), // needed? same as astronomicalDawn
                    // makeSolarChoice("astronomicalDawn", "astronomical dawn", "night ends, astronomical twilight starts (-18)"),
                    makeSolarChoice('nauticalDawn', 'nautical dawn', 'astronomical twilight ends, nautical twilight starts (-12)'),
                    makeSolarChoice('civilDawn', 'civil dawn / golden hour', 'nautical twilight ends, civil twilight and golden hour starts (-6)'),
                    // makeSolarChoice("morningGoldenHourStart", "golden hour starts", "when the sun is 6 degrees below the horizon (-6)"), //needed? same as civilDawn
                    makeSolarChoice('sunrise', 'sunrise', 'top edge of the sun appears on the horizon (-0.833)'),
                    makeSolarChoice('sunriseEnd', 'sunrise end', 'bottom edge of the sun touches the horizon (-0.3)'),
                    makeSolarChoice('morningGoldenHourEnd', 'morning golden hour ends', 'when the sun is 6 degrees above the horizon (6)'),
                    makeSolarChoice('solarNoon', 'solar noon', 'sun is at its highest position'),
                    makeSolarChoice('eveningGoldenHourStart', 'evening golden hour start', 'when the sun is 6 degrees above the horizon (6)'),
                    makeSolarChoice('sunsetStart', 'sunset start', 'bottom edge of the sun touches the horizon (-0.3)'),
                    makeSolarChoice('sunset', 'sunset', 'civil twilight starts, sun disappears below the horizon (-0.833)'),
                    // makeSolarChoice("eveningGoldenHourEnd", "evening golden hour end","golden hour ends (-6)"), //needed? same as civilDusk
                    makeSolarChoice('civilDusk', 'civil dusk / golden hour end', 'civil twilight and golden hour ends, nautical twilight starts (-6)'),
                    makeSolarChoice('nauticalDusk', 'nautical dusk', 'nautical twilight ends, astronomical twilight starts (-12)'),
                    // makeSolarChoice("astronomicalDusk", "astronomical dusk", "astronomical twilight ends, night starts (-18)"),
                    makeSolarChoice('nightStart', 'astronomical dusk / night start', 'astronomical twilight ends, night starts (-18)'), // needed? same as astronomicalDusk
                    makeSolarChoice('nadir', 'solar midnight', 'when the sun is closest to nadir and the night is equidistant from dusk and dawn')
                ]

                function isObject (o) {
                    return (typeof o === 'object' && o !== null)
                }

                $('#node-input-topic-container').css('height', 'auto').editableList({
                    addItem: function (row, index, data) {
                        const current = node._('ui-scheduler.label.topic') + ' ' + (index + 1)

                        const label = $('<span/>', { class: 'node-input-topic-label', text: ' ' + current })
                        $(row).html(label)

                        const nameInput = $('<input/>', { class: 'node-input-topic-name', type: 'text', style: 'margin-left:7px; width:calc(75% - 32px);', value: data.name || current })
                        nameInput.appendTo(row).typedInput({ default: 'str', types: ['str'] })

                        const finalspan = $('<span/>', { style: 'float: right;margin-top: 6px;' }).appendTo(row)
                        finalspan.append(' &#8594; <span class="node-input-topic-index">' + (index + 2) + '</span> ')
                    },
                    removeItem: function (opt) {
                        const topics = $('#node-input-topic-container').editableList('items')
                        topics.each(function (i) {
                            $(this).find('.node-input-topic-label').html(node._('ui-scheduler.label.topic') + ' ' + (i + 1))
                            const name = $(this).find('.node-input-topic-name').typedInput('value')
                            const regex = new RegExp('^' + node._('ui-scheduler.label.topic') + ' \\d+$')
                            if (regex.test(name)) {
                                $(this).find('.node-input-topic-name').typedInput('value', node._('ui-scheduler.label.topic') + ' ' + (i + 1))
                            }
                            $(this).find('.node-input-topic-index').html(i + 2)
                        })

                        if (topics.length === 0) $('#node-input-topic-container').editableList('addItem', {})
                    },
                    sortItems: function (rules) {
                        const topics = $('#node-input-topic-container').editableList('items')
                        topics.each(function (i) {
                            $(this).find('.node-input-topic-label').html(node._('ui-scheduler.label.topic') + ' ' + (i + 1))
                            const name = $(this).find('.node-input-topic-name').typedInput('value')
                            const regex = new RegExp('^' + node._('ui-scheduler.label.topic') + ' \\d+$')
                            if (regex.test(name)) {
                                $(this).find('.node-input-topic-name').typedInput('value', node._('ui-scheduler.label.topic') + ' ' + (i + 1))
                            }
                            $(this).find('.node-input-topic-index').html(i + 2)
                        })
                    },
                    removable: true,
                    sortable: true
                })

                if (!this.topics) {
                    $('#node-input-topic-container').editableList('addItem', { name: this.name })
                } else {
                    for (let i = 0; i < this.topics.length; i++) {
                        $('#node-input-topic-container').editableList('addItem', { name: this.topics[i] })
                    }
                }

                /**
             * Apply defaults to the cron schedule object
             * @param {integer} optionIndex An index number to use for defaults
             * @param {object} option The option object to update
            */
                function applyOptionDefaults (optionIndex, option) {
                    if (isObject(option) === false) {
                        return// no point in continuing
                    }
                    optionIndex = optionIndex == null ? 0 : optionIndex
                    if (['cron', 'dates', 'solar'].indexOf(option.expressionType) < 0) {
                        // if expressionType is not cron or solar - it may be sunrise or sunset
                        if (option.expressionType === 'sunrise') {
                            option.solarEvents = option.solarEvents || 'sunrise'
                            option.expressionType = 'solar'
                        } else if (option.expressionType === 'sunset') {
                            option.solarEvents = option.solarEvents || 'sunset'
                            option.expressionType = 'solar'
                        } else {
                            if (!option.expression) {
                                option.expressionType = 'cron'
                            } else {
                                if (!isCronLike(option.expression)) {
                                    option.expressionType = 'dates'
                                } else if (isDateSequenceLike(option.expression)) {
                                    option.expressionType = 'dates'
                                } else {
                                    option.expressionType = 'cron'
                                }
                            }
                        }
                    }
                    option.name = option.name || 'schedule' + (optionIndex + 1)
                    option.topic = option.topic || 'Topic 1'
                    option.payloadType = option.payloadType || option.type || 'default'
                    delete option.type
                    if (option.expressionType === 'cron' && !option.expression) option.expression = '0 * * * * * *'
                    if (!option.solarType) option.solarType = option.solarEvents ? 'selected' : 'all'
                    if (!option.solarEvents) option.solarEvents = 'sunrise,sunset'
                    if (!option.location) option.location = ''
                }

                /**
                 * Generate an option row on the UI
                 * @param {integer} optionIndex the index number of this schedule
                 * @param {object} option The option object to present
                */
                function generateOption (optionIndex, option) {
                    if (RED._cron_plus_debug) { console.log('generating option', optionIndex, option) }
                    applyOptionDefaults(optionIndex, option)
                    function buildExpressionTip (title, desc, text, type) {
                        const helpFunc = type === 'solar' ? 'showSolarHelp();' : 'showCronHelp();'
                        const helpFuncPopOut = type === 'solar' ? "_popoutui-schedulerHelp('ui-scheduler-solar-events-info');" : "_popoutui-schedulerHelp('ui-scheduler-expression-info');"
                        const helpFuncHtml = '<span style="float: right">' +
                            '<button id="ui-scheduler-tt-help-button" class="ui-scheduler-link-button" onclick="' + helpFunc + '">help </button>&nbsp;' +
                            '<button class="ui-scheduler-link-button" onclick="' + helpFuncPopOut + '"> <i class="fa fa-external-link"></i></button></span>'
                        return '<div style="min-height:190px"><span style="font-size: 12px; font-weight: bold">' + title + '</span>' +
                            helpFuncHtml +
                            '<hr><div>' + desc + '</div>' +
                            '<pre class="ui-scheduler-form-tip form-tips">' + text + '</pre></div>'
                    }
                    function initTooltip (selector, type, pos) {
                        if (selector.typedInput('instance') && selector.typedInput('instance').input) {
                            selector = selector.typedInput('instance').input
                        }
                        const $selector = $(selector)
                        // clear any title attr to prevent default tooltip & permit the jquery tooltip plugin to work
                        $selector.attr('title', ' ')
                        $selector.off('mouseenter').tooltip({
                            show: { effect: 'fade' },
                            tooltipClass: 'ui-scheduler-expression-tip form-tips',
                            position: pos,
                            content: function () {
                                return buildExpressionTip('Expression...', 'Getting description...', '', type)
                            },
                            disabled: true
                        }).off('focusout').off('mouseleave').mouseleave(function (e) {
                            if (RED._cron_plus_debug) console.log('initTooltip--mouseleave')
                            if ($selector.is(':focus')) {
                                if (RED._cron_plus_debug) console.log("initTooltip--mouseleave selector:is(':focus')")
                                e.preventDefault()
                                e.stopImmediatePropagation()
                                // selector.tooltip('open');
                                return false
                            }
                        }).on('blur', function (e) {
                            if (RED._cron_plus_debug) console.log('initTooltip-->on-blur.  relatedTarget:', e.relatedTarget)
                            if (e.relatedTarget && e.relatedTarget.id === 'ui-scheduler-tt-help-button') {
                                if (RED._cron_plus_debug) console.log('blur-->e.relatedTarget.relatedTarget.className == "ui-scheduler-link-button"')
                                if (type === 'cron') { showCronHelp() } else if (type === 'solar') { showSolarHelp() }
                                $(this).focus()
                                return false
                            }
                            $(this).tooltip('close').tooltip('disable')
                        }).on('focusin change keyup', function (e) {
                            if (RED._cron_plus_debug) console.log('initTooltip--focusin change keyup', e)
                            const $this = $(this)

                            const $timeZone = $('#node-input-timeZone')
                            const $expressionType = $this.closest('li').find('.node-input-option-expressionType')
                            const expressionType = $expressionType.val()
                            const $location = $this.closest('li').find('.node-input-option-location')
                            const $expression = $this.closest('li').find('.node-input-option-expression')
                            let expression
                            if (expressionType === 'solar') {
                                const defLocation = $('#node-input-defaultLocation').typedInput('value')
                                const defLocationType = $('#node-input-defaultLocation').typedInput('type')
                                if (defLocationType === 'env' || defLocationType === 'fixed') {
                                    expression = defLocation
                                } else {
                                    expression = $location.typedInput('value')
                                }
                            } else {
                                expression = $expression.val()
                            }
                            if (!expression) {
                                $this.tooltip('close').tooltip('disable')
                                return
                            }
                            const $offset = $this.closest('li').find('.node-input-option-offset')
                            const $solarEvents = $this.closest('li').find('.node-input-option-solarEvents')
                            $this.tooltip('enable').tooltip('open')
                            $this.tooltip('option', 'position', pos)
                            $this.tooltip({
                                position: pos,
                                disabled: false,
                                show: { effect: 'fade' },
                                content: function (callback) {
                                    if (RED._cron_plus_debug) console.log('initTooltip-->content')

                                    const solarType = $solarEvents.typedInput('type')
                                    const solarEvents = $solarEvents.typedInput('value')
                                    const expressionType = $expressionType.val()
                                    const offset = $offset.val()
                                    const timeZone = $timeZone.val()
                                    let titleHtml
                                    const e = { expressionType }
                                    if (timeZone) e.timeZone = timeZone
                                    if (expressionType === 'solar') {
                                        titleHtml = (expr) => {
                                            const title = '<b>solar events</b> at <span class="ui-scheduler-expression">' + expr.slice(0, 100) + (expr.length > 100 ? '...' : '') + '</span>'
                                            // eslint-disable-next-line eqeqeq
                                            if (offset != null && offset !== '0' && offset !== 0) {
                                                titleHtml += '<b>'
                                                if (offset > 0) titleHtml += ' +'
                                                titleHtml += offset + ' minute'
                                                // eslint-disable-next-line eqeqeq
                                                if (offset != '1' && offset != '-1') titleHtml += 's'
                                                titleHtml += '</b>'
                                            }
                                            return title
                                        }
                                        e.offset = offset
                                        e.location = expression
                                        e.solarType = solarType
                                        e.solarEvents = solarEvents
                                        e.defaultLocationType = $('#node-input-defaultLocation').typedInput('type')
                                        e.defaultLocation = $('#node-input-defaultLocation').typedInput('value')
                                        e.flowId = node.z
                                        e.nodeId = node.id
                                        e.nodeGroupId = node.g
                                        const env = []
                                        if (node.g) {
                                            let gId = node.g
                                            let group = RED.nodes.group(gId)
                                            while (group) {
                                                if (group.env && group.env.length) {
                                                    env.push(...group.env)
                                                }
                                                gId = group.g
                                                group = RED.nodes.group(gId)
                                            }
                                        }
                                        if (node.z && RED.nodes.workspace(node.z) && RED.nodes.workspace(node.z).env) {
                                            env.push(...RED.nodes.workspace(node.z).env)
                                        }
                                        e.env = env
                                    } else {
                                        titleHtml = (expr) => 'Description of <span class="ui-scheduler-expression">' + expr.slice(0, 50) + (expr.length > 50 ? '...' : '') + '</span>'
                                        e.expression = expression
                                    }
                                    if (RED._cron_plus_debug) console.log('initTooltip-->Ajax start, e...', e)
                                    $.ajax({
                                        type: 'POST',
                                        url: `ui-scheduler/${node.id}/expressionTip`,
                                        headers: {
                                            Accept: 'application/json',
                                            'Content-Type': 'application/json'
                                        },
                                        dataType: 'json',
                                        data: JSON.stringify(e)
                                    })
                                        .done(function (data) {
                                            if (RED._cron_plus_debug) console.log('initTooltip-->Ajax done, data...', data)
                                            let nextInfo = ''
                                            const desc = data.description
                                            if (data.prettyNext) {
                                                nextInfo = 'Next event: ' + data.prettyNext
                                                if (data.nextDates && data.nextDates.length) {
                                                    nextInfo = nextInfo + ' then...'
                                                    const makeTR = function (x) {
                                                        let v = x; let s = '<i class="fa fa-clock-o"></i>'
                                                        if (typeof x === 'object' && x.timeOffset) {
                                                            v = x.timeOffset
                                                            s = x.event || 'unknown'
                                                        }
                                                        const fd = formatDateTimeWithTZ(v, timeZone)
                                                        v = fd || undefined
                                                        return '<tr><td>' + s + '</td><td>' + v + '</td></tr>'
                                                    }
                                                    const map1 = data.nextDates.map(makeTR)
                                                    nextInfo += '<table class=>' + map1.join('\n') + '</table>'
                                                }
                                            }
                                            const okContent = function () {
                                                setTimeout(function () {
                                                    if (RED._cron_plus_debug) console.log('initTooltip-->callback-->setTimeout--> option-->position')
                                                    $this.tooltip('option', 'position', pos)
                                                    $this.tooltip('enable').tooltip('open')
                                                    $this.tooltip('option', 'position', pos)
                                                }, 200)
                                                const expr = data.expressionType === 'solar' ? data.location : data.expression
                                                return buildExpressionTip(titleHtml(expr), desc, nextInfo, expressionType)
                                            }
                                            callback(okContent)
                                            $this.tooltip('option', 'position', pos)
                                        })
                                        .fail(function (jqXHR, textStatus, errorThrown) {
                                            console.error(jqXHR, textStatus, errorThrown)
                                            const errContent = buildExpressionTip('Error...', 'Cannot get description from node-red', '', expressionType)
                                            callback(errContent)
                                        })
                                }
                            })
                        })
                    }
                    if (RED._cron_plus_debug) { console.log('setting up schedule fields') }
                    // styles for the option row 1
                    const nameStyle = 'display: flex; flex-grow: 0; flex-basis:128px; margin-right:5px;'
                    const topicStyle = 'display: flex; flex-grow: 1; flex-basis: 140px; margin-right: 5px;'
                    const payloadStyle = 'display: flex; flex-grow: 2; flex-basis: 250px;'
                    // styles for the option row 2
                    const scheduleTypeStyle = 'display: flex; flex-grow: 0; flex-basis:128px; margin-right:5px; padding-left: 2px; padding-right: 10px;' // padding hack for text alignment
                    const row2Col2Style = 'display: flex; flex-grow: 1;'
                    // row 2 col 2 child styles (for solar)
                    const solarEventsStyle = 'display: flex; flex-grow: 1; flex-basis: 140px; margin-right: 5px;'
                    const locationStyle = 'display: flex; flex-grow: 3; width:100%; margin-right:5px;'
                    const solarOffsetStyle = 'display: flex; flex-grow: 0; flex-basis:180px;'

                    // control buttons container styles
                    const controlsContainerStyle = 'float: right; height: 74px; margin-left: 5px; flex-direction: column; display: flex; justify-content: space-evenly; align-items: center; border-left: var(--red-ui-form-button-background) 1px solid; padding-left: 5px;'

                    // build options row
                    const container = $('<li/>')
                    // const container = $('<li/>', { style: 'max-width: 600px' })

                    // row buttons
                    const controlsContainer = $('<span/>', { style: controlsContainerStyle }).appendTo(container)
                    const deleteButton = $('<a/>', { href: '#', class: 'editor-button editor-button-small', style: '' }).appendTo(controlsContainer)
                    $('<i/>', { class: 'fa fa-remove' }).appendTo(deleteButton)
                    RED.popover.tooltip(deleteButton, 'Delete')
                    const sortHandle = $('<a/>', { href: '#', class: 'editor-button editor-button-small node-input-option-handle', style: 'cursor: grab' }).appendTo(controlsContainer)
                    $('<i/>', { class: 'fa fa-bars' }).appendTo(sortHandle)
                    RED.popover.tooltip(sortHandle, 'Move')

                    // #### ROW 1 ####
                    const row1 = $('<div style="display: flex; margin: 0px 0px 5px 0px"/>').appendTo(container)

                    // generate the name field
                    const nameClass = 'node-input-option-name' + ((!option.name || dupCheck[option.name]) ? ' input-error' : '')
                    const nameField = $('<input/>', { class: nameClass, type: 'text', style: nameStyle, placeholder: 'name', title: 'name', value: option.name }).appendTo(row1)
                    dupCheck[option.name] = true

                    // // generate the topic field
                    // const topicClass = 'node-input-option-topic' + ((!option.topic) ? ' input-error' : '')
                    // const topicField = $('<input/>', { class: topicClass, type: 'text', style: topicStyle, placeholder: 'topic', title: 'topic', value: option.topic }).appendTo(row1)
                    // generate the topic field
                    const topicClass = 'node-input-option-topic' + ((!option.topic) ? ' input-error' : '')
                    const topicField = $('<select/>', {
                        class: topicClass,
                        style: topicStyle,
                        title: 'topic'
                    }).appendTo(row1)
                    // Populate the dropdown with topics
                    node.topics.forEach(topic => {
                        $('<option/>', {
                            value: topic,
                            text: topic
                        }).appendTo(topicField)
                    })

                    // Set the selected value if any
                    if (option.topic) {
                        topicField.val(option.topic)
                    }

                    // generate the payload field
                    const payloadDiv = $('<div/>', { style: payloadStyle }).appendTo(row1)
                    const payloadField = $('<input/>', { class: 'node-input-option-payload', type: 'text', style: 'width: 100%', placeholder: 'payload', value: option.payload || '' }).appendTo(payloadDiv)
                    payloadField.typedInput({
                        default: option.payloadType || 'default',
                        types: [{
                            icon: 'fa fa-envelope',
                            value: 'default',
                            label: 'Default Payload',
                            hasValue: false
                        }, 'flow', 'global', 'str', 'num', 'bool', 'json', 'jsonata', 'bin', 'date', 'env']
                    })

                    // #### ROW 2 ####
                    const row2 = $('<div style="display: flex; margin: 0px 0px 5px 0px"/>').appendTo(container)

                    // generate a dropdown for schedule type
                    const scheduleType = option.expressionType || 'cron'
                    const scheduleTypeField = $('<select/>', { class: 'node-input-option-expressionType', type: 'text', placeholder: 'cron', style: scheduleTypeStyle }).appendTo(row2)
                    $('<option />', { value: 'cron', text: 'cron' }).appendTo(scheduleTypeField)
                    $('<option />', { value: 'dates', text: 'date sequence' }).appendTo(scheduleTypeField)
                    $('<option />', { value: 'solar', text: 'solar events' }).appendTo(scheduleTypeField)
                    scheduleTypeField.val(scheduleType)
                    scheduleTypeField.prop('title', 'Expression Type')

                    // generate cell2
                    const cell2Cron = $('<div>', { style: row2Col2Style }).appendTo(row2)
                    const cell2Solar = $('<div>', { style: row2Col2Style }).appendTo(row2)

                    // generate a combo for cron expression
                    const expression = option.expression == null ? '0 * * * * * *' : option.expression
                    const expressionClass = 'node-input-option-expression' + ((!expression) ? ' input-error' : '')
                    const expressionMenuData = [
                        { label: 'Easy Expression Builder', value: 'EEB' },
                        { label: 'Every Second (* * * * * *)', value: '* * * * * *' },
                        { label: 'Every minute (0 * * * * *)', value: '0 * * * * *' },
                        { label: 'Every 10 minutes (0 */10 * * * *)', value: '0 */10 * * * *' },
                        { label: 'Every day at noon - 12pm (0 0 12 * * *)', value: '0 0 12 * * *' },
                        { label: 'Every 20 minutes, at 9:00 AM and 5:00 PM (0 */20 9,17 * * *)', value: '0 */20 9,17 * * *' },
                        { label: 'At 15, 30, and 45 minutes past the hour (0 15,30,45 * * * *)', value: '0 15,30,45 * * * *' },
                        { label: 'At 02:00 AM, on day 29 of Feb (0 0 2 29 FEB * 2020/4)', value: '0 0 2 29 FEB * 2020/4' },
                        { label: 'At 07:00 AM, on the 1st Mon of the month (0 0 7 * * MON#1 *)', value: '0 0 7 * * MON#1 *' },
                        { label: 'Every day at noon in Jan, Mar & Dec (0 0 12 * JAN,MAR,DEC *)', value: '0 0 12 * JAN,MAR,DEC *' },
                        { label: 'Every minute, on the 1st weekday of the month (* * 1W * *)', value: '* * 1W * *' },
                        { label: 'Every minute, on the third Tue of the month (* * * * Tue#3)', value: '* * * * Tue#3' },
                        { label: 'At 12:00 PM, on the last Monday of the month (0 12 * * MONL)', value: '0 12 * * MONL' }
                    ]

                    const expressionField = $('<input/>', {
                        class: expressionClass,
                        type: 'text',
                        placeholder: '* * * * * * *',
                        list: 'cron-expression-example-list',
                        title: 'cron expression',
                        value: option.expression
                    })
                    expressionField.appendTo(cell2Cron)

                    // setup the expression combo
                    expressionField.combobox({
                        style: 'width: 100%',
                        menu: {
                            menu: expressionMenuData,
                            options: {
                                beforeSelect: function (opt) {
                                    if (opt && opt.value === 'EEB') {
                                        $('#ui-scheduler-expression-builder-dialog').data('opener', expressionField)
                                        $('#ui-scheduler-expression-builder-dialog').dialog('open')
                                        return true // return true to let widget know - we have handled this
                                    }
                                }
                            }
                        },
                        validate: function (value) {
                            return (!!value) && value.length >= 9// better validation required?
                        }
                    })
                    try {
                        expressionField.combobox().button.prop('title', 'Expression examples...')
                        expressionField.combobox('instance').button.prop('title', 'Expression examples...')
                        // eslint-disable-next-line no-empty
                    } catch (error) { }
                    expressionField.combobox('value', option.expression || '')

                    // generate the solar events field
                    const solarEventsDiv = $('<div/>', { style: solarEventsStyle }).appendTo(cell2Solar)
                    const solarEventsField = $('<input/>', { class: 'node-input-option-solarEvents', type: 'text', style: 'width: 100%', placeholder: 'select solar events', value: option.solarEvents || '' }).appendTo(solarEventsDiv)
                    solarEventsField.typedInput({
                        default: 'all',
                        types: [
                            {
                                value: 'selected',
                                label: 'Selected Solar Events',
                                title: 'Selected Solar Events',
                                icon: 'fa fa-list',
                                showLabel: false,
                                multiple: true,
                                options: solarChoices,
                                default: ['sunrise', 'sunset']
                            },
                            {
                                value: 'all',
                                label: 'All Solar Events',
                                title: 'All Solar Events',
                                icon: 'fa fa-sun-o',
                                hasValue: false,
                                showLabel: true
                            }
                        ]
                    })
                    solarEventsField.typedInput('type', option.solarType || 'all')
                    solarEventsField.typedInput('value', option.solarEvents || '')// added as setting value on invocation doesnt seem to set the "2 selected" text of the widget!

                    // generate location
                    const locationFieldDiv = $('<div/>', { class: 'ui-scheduler-node-input-option-location-div', style: locationStyle }).appendTo(cell2Solar)
                    const locationField = $('<input/>', { class: 'node-input-option-location', type: 'text', style: 'width: 100%', placeholder: 'lat lng', value: option.location || '' }).appendTo(locationFieldDiv)
                    locationField.typedInput({
                        default: 'fixed',
                        types: [
                            {
                                value: 'fixed',
                                label: 'Fixed Location',
                                icon: 'fa fa-map-pin',
                                expand: function () {
                                    // eslint-disable-next-line no-undef
                                    showMap(locationField)
                                },
                                validate: function (v, opt) { return !!v && v.length >= 3 }
                            }
                        ]
                    })
                    locationField.typedInput('value', option.location || '')

                    // const locationGroup = $('<div class="red-ui-typedInput-container node-input-option-location" style="' + locationStyle + '">' +
                    //     '<button class="red-ui-typedInput-type-select" style="width:25px" title="Show Map..."><i class="fa fa-map-marker "> </i></button>' +
                    //     '<div class="red-ui-typedInput-input red-ui-typedInput-input-wrap" style="left: 25px; right: 0px;">' +
                    //     '<input class="red-ui-typedInput-input node-input-option-location" type="text" value="" placeholder="lat lng"></div> </div>')
                    // const locationField = locationGroup.find('input')
                    // const locationButton = locationGroup.find('button')
                    // locationField.prop('title', 'Location coordinates...')
                    // locationButton.prop('title', 'Show Map...')
                    // if (!option.location) {
                    //     locationGroup.addClass('input-error')
                    // } else {
                    //     locationField.val(option.location)
                    // }
                    // locationGroup.appendTo(cell2)

                    // locationButton.on('click', function () {
                    //     $('#ui-scheduler-map-dialog').dialog('open')
                    //     selectedLocationInput = $(this).closest('li').find('.node-input-option-location')
                    //     if (navigator.onLine === true) {
                    //         $('.ui-scheduler-map-not-loaded').show()
                    //         $('.ui-scheduler-map-loading').hide()
                    //         $('#ui-scheduler-map').hide()
                    //         const proto = location.protocol === 'https:' ? location.protocol : 'http:'
                    //         checkLoadJsCssFile(proto + '//libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css', 'css', function () {
                    //             checkLoadJsCssFile(proto + '//libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.uncompressed.js', 'js', function () {
                    //             })
                    //             createMap(selectedLocationInput)
                    //         })
                    //     } else {
                    //         $('.ui-scheduler-map-not-loaded').show()
                    //         $('.ui-scheduler-map-loading').hide()
                    //         $('#ui-scheduler-map').hide()
                    //     }
                    // })

                    // offset fields
                    const offsetField = $('<input/>', { class: 'node-input-option-offset', type: 'number', min: -1439, max: 1439, style: solarOffsetStyle, value: option.offset || 0, placeholder: 'offset' }).appendTo(cell2Solar)
                    offsetField.prop('title', 'Minutes Offset +/- 1439')

                    // init tooltips
                    initTooltip(offsetField, 'solar', { my: 'middle top', at: 'middle bottom+5', of: cell2Solar, collision: 'flipfit' })
                    initTooltip(locationField, 'solar', { my: 'middle top', at: 'middle bottom+5', of: cell2Solar, collision: 'flipfit' })
                    initTooltip(expressionField, 'cron', { my: 'middle top', at: 'middle bottom+5', of: cell2Cron, collision: 'flipfit' })

                    // locationField.keyup(function () {
                    //     const f = $(this)
                    //     const fg = locationGroup
                    //     if (f.val() && fg.hasClass('input-error')) {
                    //         fg.removeClass('input-error')
                    //     } else if (!f.val()) {
                    //         fg.addClass('input-error')
                    //     }
                    // })

                    nameField.keyup(function () {
                        if ($(this).val() && $(this).hasClass('input-error')) {
                            $(this).removeClass('input-error')
                        } else if (!$(this).val()) {
                            $(this).addClass('input-error')
                        }
                    })

                    // locationField.change(function () {
                    //     if ($(this).val() && locationGroup.hasClass('input-error')) {
                    //         locationGroup.removeClass('input-error')
                    //     } else if (!$(this).val()) {
                    //         locationGroup.removeClass('input-error')
                    //     }
                    // })

                    topicField.keyup(function () {
                        if ($(this).val() && $(this).hasClass('input-error')) {
                            $(this).removeClass('input-error')
                        } else if (!$(this).val()) {
                            $(this).addClass('input-error')
                        }
                    })

                    deleteButton.click(function () {
                        container.fadeOut(200, function () {
                            $(this).remove()
                        })
                    })

                    scheduleTypeField.change(function () {
                        const value = scheduleTypeField.val()
                        const showLocationGroup = $('#node-input-defaultLocation').typedInput('type') === 'default' || !$('#node-input-defaultLocation').typedInput('type')
                        locationFieldDiv.toggleClass('ui-scheduler-hide-per-location', !showLocationGroup)
                        switch (value) {
                        case 'solar':
                            cell2Cron.hide()
                            cell2Solar.show()
                            break
                        case 'dates':
                            cell2Cron.show()
                            cell2Solar.hide()
                            expressionField.combobox('hideMenu')
                            break
                        default: // cron
                            cell2Cron.show()
                            cell2Solar.hide()
                            expressionField.combobox('showMenu')
                            break
                        }
                    })
                    scheduleTypeField.triggerHandler('change')
                    $('#node-input-option-container').append(container)
                }

                $('#node-input-outputField').typedInput({ types: [{ label: 'msg.', value: 'str' }] })

                $('#node-input-add-option').click(function () {
                    generateOption($('#node-input-option-container').children().length, {})
                    $('#node-input-option-container-div').scrollTop($('#node-input-option-container-div').get(0).scrollHeight)
                    // focus the input with class .node-input-option-name in the last li added
                    $('#node-input-option-container').children().last().find('.node-input-option-name').focus().select()
                })

                $('#node-input-show-dynamic').click(function () {
                    $('#ui-scheduler-dynamic-nodes-dialog').dialog('open')
                })

                removeEventListener('fullscreenchange', onSchedulesExpandCompress)
                addEventListener('fullscreenchange', onSchedulesExpandCompress)

                $('#ui-scheduler-expand-schedules-button').click(function (evt) {
                    const selector = '#node-ui-scheduler-tab-static-schedules'
                    if (evt) {
                        // prevent the default behaviour - we will handle it
                        evt.preventDefault()
                        evt.stopImmediatePropagation()
                    }

                    // if shift key or middle mouse button or already full screen then toggle full screen
                    if (evt.shiftKey || evt.button === 1 /* middle button */ || document.fullscreenElement) {
                        toggleFullscreen(selector, function (err) {
                            updateEditorLayout()
                        })
                    } else {
                        // CSS expansion/contraction
                        const el = $(selector)
                        const isSmall = el.css('position') !== 'fixed' && !document.fullscreenElement
                        if (isSmall) {
                            // is small - make it big
                            el.addClass('ui-scheduler-expanded-element').removeClass('ui-scheduler-fullscreen-element')
                        } else {
                            // is big - make it small
                            el.removeClass('ui-scheduler-expanded-element').removeClass('ui-scheduler-fullscreen-element')
                        }
                        updateEditorLayout()
                    }
                })

                for (let i = 0; i < this.options.length; i++) {
                    const option = this.options[i]
                    try {
                        generateOption(i, option)
                    } catch (error) {
                        console.warn('generateOption caused an error: ', option, error)
                    }
                }

                $('#node-input-option-container').sortable({
                    axis: 'y',
                    handle: '.node-input-option-handle',
                    cursor: 'grabbing',
                    cursorAt: { right: 5 },
                    // placeholder: "ui-corner-all"
                    snap: '#node-input-option-container',
                    snapMode: 'inner',
                    forceHelperSize: true,
                    forcePlaceholderSize: true,
                    tolerance: 'pointer',
                    appendTo: $('#node-input-option-container')
                })

                updateEditorLayout()

                // give the form a chance to render then remove the max width restriction
                setTimeout(function () {
                    $('#node-ui-scheduler-tab-static-schedules').css('max-width', '')
                }, 200)
            },
            oneditsave: function () {
                if (RED._cron_plus_debug) { console.log('oneditsave - ui-scheduler') }
                removeEventListener('fullscreenchange', onSchedulesExpandCompress)
                const node = this
                const options = $('#node-input-option-container').children()

                node.options = []
                // eslint-disable-next-line no-unused-vars
                options.each(function (i) {
                    const option = $(this)
                    const o = {
                        name: option.find('.node-input-option-name').val(),
                        topic: option.find('.node-input-option-topic').val(),
                        payloadType: option.find('.node-input-option-payload').typedInput('type'),
                        payload: option.find('.node-input-option-payload').typedInput('value'),
                        expressionType: option.find('.node-input-option-expressionType').val(),
                        expression: option.find('.node-input-option-expression').val(),
                        location: option.find('.node-input-option-location').typedInput('value'),
                        offset: option.find('.node-input-option-offset').val(),
                        solarType: option.find('.node-input-option-solarEvents').typedInput('type') || 'all',
                        solarEvents: option.find('.node-input-option-solarEvents').typedInput('value')
                    }
                    if (option.find('.node-input-option-value').typedInput('type') === 'num') {
                        o.payload = Number(o.value)
                    }
                    if (option.find('.node-input-option-value').typedInput('type') === 'bool') {
                        // eslint-disable-next-line eqeqeq
                        o.payload = (o.value == 'true')
                    }
                    node.options.push(o)
                })

                const o = $('#node-input-commandResponseMsgOutput').val()
                node.commandResponseMsgOutput = ['output1', 'output2', 'fanOut'].indexOf(o) >= 0 ? o : 'output1'
                const fanOut = node.commandResponseMsgOutput === 'fanOut'

                node.topics = []
                const topics = $('#node-input-topic-container').editableList('items')
                topics.each(function (i) {
                    const topic = $(this)
                    let topicName = topic.find('.node-input-topic-name').typedInput('value')
                    topicName = topicName === '' ? node._('ui-scheduler.label.topic') + ' ' + (i + 1) : topicName
                    while (node.topics.includes(topicName)) {
                        topicName = topicName + '_' + node._('ui-scheduler.copy')
                    }

                    node.topics.push(topicName)
                })

                // Custom payload options for saving
                const customPayloads = $('#node-input-customPayload-container').children()
                node.customPayloads = []

                customPayloads.each(function () {
                    const customPayload = $(this)
                    const o = {
                        label: customPayload.find('.node-input-customPayload-label').val(),
                        value: customPayload.find('.node-input-customPayload-value').typedInput('value'),
                        type: customPayload.find('.node-input-customPayload-value').typedInput('type'),
                        id: customPayload.data('id') || generateUniqueId()
                    }

                    // Parse value based on type
                    if (o.type === 'num') {
                        o.value = Number(o.value)
                    } else if (o.type === 'json') {
                        try {
                            o.value = JSON.parse(o.value)
                        } catch (e) {
                            o.value = '{}'
                        }
                    }

                    node.customPayloads.push(o)
                })

                node.defaultLocationType = $('#node-input-defaultLocation').typedInput('type')
                node.defaultLocation = $('#node-input-defaultLocation').typedInput('value')
                node.outputs = node.commandResponseMsgOutput === 'output1' ? 1 : 2
                if (fanOut && node.topics && node.topics.length) {
                    node.outputs = 1 + node.topics.length
                }
                $('#node-input-timeZone').off()
                $('#node-input-crontab').off()
            },
            oneditcancel: function () {
                if (RED._cron_plus_debug) { console.log('oneditcancel - ui-scheduler') }
                removeEventListener('fullscreenchange', onSchedulesExpandCompress)
                $('#node-input-timeZone').off()
                $('#node-input-crontab').off()
            },
            button: {
                visible: function () {
                    if (this.options && this.options.length === 1) {
                        return true
                    }
                    return false
                },
                enabled: function () {
                    return !this.changed
                },
                onclick: function () {
                    if (RED._cron_plus_debug) { console.log('button.onclick - ui-scheduler') }
                    const node = this
                    if (node.changed) {
                        return RED.notify(RED._('notification.warning', { message: RED._('notification.warnings.undeployedChanges') }), 'warning')
                    }
                    let label = node._def.label.call(node)
                    if (label.length > 30) {
                        label = label.substring(0, 50) + '...'
                    }
                    label = label.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    $.ajax({
                        url: 'ui-schedulerinject/' + node.id,
                        type: 'POST',
                        // eslint-disable-next-line no-unused-vars
                        success: function (response) {
                            RED.notify(node._('inject.success', { label }), { type: 'success', id: 'inject' })
                        },
                        // eslint-disable-next-line no-unused-vars
                        error: function (jqXHR, textStatus, errorThrown) {
                            if (jqXHR.status === 404) {
                                RED.notify(node._('common.notification.error', { message: node._('common.notification.errors.not-deployed') }), 'error')
                            } else if (jqXHR.status === 500) {
                                RED.notify(node._('common.notification.error', { message: node._('inject.errors.failed') }), 'error')
                            } else if (jqXHR.status === 0) {
                                RED.notify(node._('common.notification.error', { message: node._('common.notification.errors.no-response') }), 'error')
                            } else {
                                RED.notify(node._('common.notification.error', { message: node._('common.notification.errors.unexpected', { status: jqXHR.status, message: textStatus }) }), 'error')
                            }
                        }
                    })
                }
            },
            oneditresize: function () {
                // console.log("RESIZING")
                updateEditorLayout()
                // HACK for old versions of node-red - prior to typedInput resizing changed from code to CSS
                if (RED.settings.version && RED.settings.version.split('.')[0] < 1) {
                    const tics = $('.red-ui-typedInput-container')
                    if (tics && tics.length) {
                        for (let idx = 0; idx < tics.length; idx++) {
                            const element = $(tics[idx])
                            if (element && element.length && element.is(':visible')) {
                                element.css('display', 'inline-block')
                            }
                        }
                    }
                }
            }
        })
    })(jQuery)

    function _popoutsSchedulerHelp (tag) {
        const startTag = (name) => `<${name}>`
        const endTag = (name) => `</${name}>`
        const winHtml = `
            ${startTag('html')}
                ${startTag('head')}
                    ${startTag('title')}ui-scheduler help${endTag('title')}
                    ${startTag('style')}
                    .fade-in {
                        transition: opacity 1.5s ease-in-out;
                    }
                    .hidden {
                        opacity: 0;
                        visibility: hidden;
                    }
                    ${endTag('style')}
                ${endTag('head')}
                ${startTag('body')}
                    ${startTag('script')}
                        const styles = ${JSON.stringify([].map.call(document.querySelectorAll('[rel="stylesheet"]'), e => e.href))}
                        const head = document.head || document.getElementsByTagName('head')[0]
                        styles.forEach(href => {
                            const el = document.createElement('link');
                            el.rel="stylesheet"
                            el.href = href
                            head.appendChild(el);
                        })
                    ${endTag('script')}
                    <div class="red-ui-editor help-content hidden" style="height: 100%">
                        <div class="red-ui-sidebar-info">
                            <div class="red-ui-sidebar-help-stack red-ui-panels" style="height: 100%;">
                                <div class="red-ui-panel" style="overflow-y: auto;height: 100%;">
                                    <div class="red-ui-help" style="padding: 6px;height: 100%;">
                                        <h1 class="red-ui-help-title">ui-scheduler</h1>
                                        <div class="red-ui-help">
                                            <span class="red-ui-text-bidi-aware">
                                                ${RED.nodes.getNodeHelp('ui-scheduler')}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${startTag('script')}
                        if (navigator.clipboard) {
                            document.querySelector('.ui-scheduler-link-button').classList.add('hidden')
                            const content = document.querySelector('.help-content');
                            content.classList.add('hidden')
                            content.classList.remove('hidden')
                            content.classList.add('fade-in')
                            const copyButtonLabel = "Copy"
                            const blocks = document.querySelectorAll("pre.ui-scheduler-code")
                            blocks.forEach((block) => {
                                const button = document.createElement("button")
                                button.innerText = copyButtonLabel
                                button.classList.add('ui-scheduler-copy-button')
                                button.addEventListener("click", copyCode)
                                block.appendChild(button)
                            })
                        }
                        async function copyCode(event) {
                            const button = event.srcElement
                            const pre = button.parentElement
                            const code = pre.querySelector("code")
                            const text = code.innerText
                            await navigator.clipboard.writeText(text)
                        }
                    ${endTag('script')}
                ${endTag('body')}
            ${endTag('html')}`

        const BOM = new Uint8Array([0xEF, 0xBB, 0xBF])
        const winUrl = URL.createObjectURL(
            new Blob([BOM, winHtml], { encoding: 'UTF-8', type: 'text/html;charset=UTF-8' })
        )
        const win = window.open(
            winUrl + (tag ? '#' + tag : ''),
            'win',
            'width=800,height=600'
        )
    }

    function onSchedulesExpandCompress () {
        const selector = '#node-ui-scheduler-tab-static-schedules'
        const el = $(selector)
        const $buttonExpandIcon = $('#ui-scheduler-expand-schedules-button').find('i.fa')
        const isBig = el.css('position') === 'fixed' || document.fullscreenElement
        if (isBig) {
            // is big - set the icon to compress & hide certain elements
            $buttonExpandIcon.removeClass('fa-expand').addClass('fa-compress')
            $('#node-input-show-dynamic').addClass('ui-scheduler-vanish-element')
        } else {
            // is small - set the icon to expand & show elements
            $buttonExpandIcon.removeClass('fa-compress').addClass('fa-expand')
            $('#node-input-show-dynamic').removeClass('ui-scheduler-vanish-element')
        }
    }
</script>

<script type="text/html" data-template-name="ui-scheduler">

        <div id="ui-scheduler-map-dialog" style="display: none;" title="Choose location...">
            <div class="ui-scheduler-map-loading" >
                <h3>Attempting to load map... <i class="fa fa-spinner fa-spin" style="font-size:24px"></i></h3>
                <p>The interactive Map is loaded via CDN at client side (to minimise installation size) and therefore requires an internet connection. Please wait 1 moment.</p>
                <h4>Alternative ways to get coordinates...</h4>
                <ul> 
                    <li>Visit <a href="https://www.latlong.net/" target="_blank" rel="noopener noreferrer">www.latlong.net</a> (on another device if required) then copy the "Lat Long" value provided into the ui-scheduler coordinates box</li>
                    <li>Visit google maps, MSN maps, almost any other maps website on another device to get GPS or longitude latitude value</li>
                    <li>Try one of the many longitude latitude apps available in the app store on your mobile phone</li>
                    <li>Check your satnav device - it may show coordinates</li>
                    <li>Use a topographic map</li>
                    <li>Ask a friend</li>
                </ul>
                <h4>Accepted formats...</h4> 
                <ul>
                    <li>Decimal Degrees E.g: <code class="ui-scheduler-coordinates">54.9992500,-1.4170300</code> or <code class="ui-scheduler-coordinates">54.9992500 N 1.4170300 W</code></li>
                    <li>Degrees Minutes Seconds E.g: <code class="ui-scheduler-coordinates">54 59' 57.3'' N 1 25' 1.308'' W</code></li>
                    <li>Decimal Minutes E.g: <code class="ui-scheduler-coordinates">54 59.955' , -1 25.0218'</code></li>
                    <li>GPS E.g: <code class="ui-scheduler-coordinates">N5459'57.3, W125'1.308"</code>, <code class="ui-scheduler-coordinates">5459'57.3"N, 125'1.308"W</code>, <code class="ui-scheduler-coordinates">54d 59' 57" N 1d 25' 1" W</code> or <code class="ui-scheduler-coordinates">54:59:57.3N 1:25:1.308W</code></li>
                </ul>    
            </div>
            <div class="ui-scheduler-map-not-loaded"  style="display:hidden" >
                <h3>No internet on this device?</h3>
                <p>The interactive Map is loaded via CDN at client side (to minimise installation size) and therefore requires an internet connection. As you are seeing this message, it is likely this device does not have access to the internet.</p>
                <h4>Alternative ways to get coordinates...</h4>
                <ul> 
                    <li>Visit <a href="https://www.latlong.net/" target="_blank" rel="noopener noreferrer">www.latlong.net</a> (on another device if required) then copy the "Lat Long" value provided into the ui-scheduler coordinates box</li>
                    <li>Visit google maps, MSN maps, almost any other maps website on another device to get GPS or longitude latitude value</li>
                    <li>Try one of the many longitude latitude apps available in the app store on your mobile phone</li>
                    <li>Check your satnav device - it may show coordinates</li>
                    <li>Use a topographic map</li>
                    <li>Ask a friend</li>
                </ul>
                <h4>Accepted formats...</h4>
                <ul>
                    <li>Decimal Degrees E.g: <code class="ui-scheduler-coordinates">54.9992500,-1.4170300</code> or <code class="ui-scheduler-coordinates">54.9992500 N 1.4170300 W</code></li>
                    <li>Degrees Minutes Seconds E.g: <code class="ui-scheduler-coordinates">54 59' 57.3'' N 1 25' 1.308'' W</code></li>
                    <li>Decimal Minutes E.g: <code class="ui-scheduler-coordinates">54 59.955' , -1 25.0218'</code></li>
                    <li>GPS E.g: <code class="ui-scheduler-coordinates">N5459'57.3, W125'1.308"</code>, <code class="ui-scheduler-coordinates">5459'57.3"N, 125'1.308"W</code>, <code class="ui-scheduler-coordinates">54d 59' 57" N 1d 25' 1" W</code> or <code class="ui-scheduler-coordinates">54:59:57.3N 1:25:1.308W</code></li>
                </ul>
            </div>
            <div id="ui-scheduler-map"></div>
        </div>
    
        <div id="ui-scheduler-dynamic-nodes-dialog" style="display: none;" title="Dynamic schedules...">
            <div id="ui-scheduler-dynamic-nodes-table-placeholder"  style="display: flex;align-items: center;/*justify-content: center;*/">
            </div>
            <div id="ui-scheduler-dynamic-nodes-loader" style="position: absolute;  left: 46%;  top: 46%;">
                <i class="fa fa-spinner fa-spin" style="font-size:48px"></i>
            </div>
        </div>
    
        <div id="ui-scheduler-expression-builder-dialog" style="display: none;" title="Easy Expression Builder...">
            <div id="ui-scheduler-expression-builder" >
            </div>
        </div>
    
        <!-- For Rows -->
        <div class="form-row ui-scheduler-form-row">
            <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
            <input type="text" id="node-input-name" style="width: calc(100% - 130px)" placeholder="Name">
        </div>
        <div class="form-row ui-scheduler-form-row">
            <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
            <input type="text" id="node-input-group">
        </div>
        <div class="form-row nr-db-ui-element-sizer-row">
            <label><i class="fa fa-object-group"></i> <span data-i18n="ui-switch.label.size">Size</label>
            <button class="editor-button" id="node-input-size"></button>
        </div>
        <div class="form-row nr-db-ui-manual-size-row">
            <label><i class="fa fa-arrows-h"></i> <span data-i18n="ui-switch.label.width">Width</label>
            <input type="hidden" id="node-input-width">
        </div>
        <div class="form-row nr-db-ui-manual-size-row">
            <label><i class="fa fa-arrows-v"></i> <span data-i18n="ui-switch.label.height">Height</label>
            <input type="hidden" id="node-input-height">
        </div>
        <div class="form-row ui-scheduler-form-row">
            <label for="node-input-label"><i class="fa fa-i-cursor"></i> Label</label>
            <input type="text" id="node-input-label">
        </div>
        <div class="form-row ui-scheduler-form-row">
            <label for="node-input-timeZone"><i class="fa fa-globe"></i> Timezone</label>
            <input type="text" id="node-input-timeZone" style="width: calc(100% - 130px)" placeholder="Leave empty for none/system">
        </div>
        <div class=" form-row ui-scheduler-form-row">
            <label for="node-input-use24HourFormat"><i class="fa fa-clock-o"></i> 24 Hour Format </label>
            <input type="checkbox" id="node-input-use24HourFormat" style="display: inline-block; width: auto; margin: 0px 0px 0px 4px;">
        </div>
        <div class="form-row ui-scheduler-form-row">
            <label for="node-input-defaultLocation"><i class="fa fa-map-marker"></i> Location</label>
            <input type="text" id="node-input-defaultLocation" style="width: calc(100% - 130px)" placeholder="lat lng (optional)">
        </div>
        <div class="form-row ui-scheduler-form-row">
            <label for="node-input-commandResponseMsgOutput"><i class="fa fa-dot-circle-o"></i> Outputs</label>
            <select style="width: calc(100% - 130px)" id="node-input-commandResponseMsgOutput">
              <option value="output1">1 output: All messages to output 1</option>
              <option value="output2">2 outputs: Command responses to output 1, Schedule messages to output 2</option>
              <option value="fanOut" >Fan out: Separate outputs for command messages and each topic</option>
            </select>
        </div>

        <div class="form-row">
            <label for="node-input-send-state-container-div" style="vertical-align:top;width:auto">
                <i class="fa fa-refresh"></i> Send State of Schedules:
            </label>
            <div id="node-input-send-state-container-div" class="form-row" style="box-sizing:border-box; border-radius:5px; padding:5px; border:1px solid var(--red-ui-form-input-border-color, #ccc); overflow-y:auto; width: 100%;">
                <span>
                    <label style="width:auto; vertical-align:top" for="node-input-sendStateInterval"><i class="fa fa-refresh"></i>
                        <span data-i18n="ui-scheduler.label.sendStateInterval"></span>
                    </label>
                    <input type="number" id="node-input-sendStateInterval" min="1" max="60"
                        style="display:inline-block; width:auto; vertical-align:top; margin-right:50px;" />
                </span>
                <span>
                    <label style="width:auto; vertical-align:top" for="node-input-sendActiveState"><i class="fa fa-dot-circle-o"></i>
                        <span data-i18n="ui-scheduler.label.sendActiveState"></span>
                    </label>
                    <input type="checkbox" id="node-input-sendActiveState"
                        style="display:inline-block; width:auto; vertical-align:top; margin-right:50px;">
                    <span data-i18n="ui-scheduler.sendActiveState"></span>
                </span>
                <span>
                    <label style="width:auto; vertical-align:top" for="node-input-sendInactiveState"><i class="fa fa-dot-circle-o"></i>
                        <span data-i18n="ui-scheduler.label.sendInactiveState"></span>
                    </label>
                    <input type="checkbox" id="node-input-sendInactiveState"
                        style="display:inline-block; width:auto; vertical-align:top; margin-right:50px;">
                    <span data-i18n="ui-scheduler.sendInactiveState"></span>
                </span>
            </div>
        </div>

        <div class="form-row ui-scheduler-form-row">
            <label for="node-input-storeName"><i class="fa fa-database"></i> Persist Schedules</label>
            <select type="text" id="node-input-storeName" style="width: calc(100% - 130px);"></select>
        </div>

        <div class="form-row ui-scheduler-form-row form-row-flex node-input-topic-container-row" style="margin-bottom: 0px;width: 100%">
            <label for="node-input-topic-container-div"><i class="fa fa-list-alt"></i> <span
                    data-i18n="ui-scheduler.label.topics"></span> </label>
                    <div id="node-input-topic-container-div">
                        <ol id="node-input-topic-container" style="list-style-type:none; margin:0; max-height: 200px;"></ol>
                    </div>
        </div>
        
        <div class="form-row ui-scheduler-form-row form-row-flex node-input-customPayload-container-row" style="margin-top: 20px; margin-bottom: 0px; width: 100%">
            <label for="node-input-customPayload-container-div"><i class="fa fa-list-alt"></i> Custom Payloads</label>
            <div id="node-input-customPayload-container-div" style="box-sizing:border-box; border-radius:5px; height:auto; max-height: 200px; padding:5px; border:1px solid var(--red-ui-form-input-border-color, #ccc); overflow-y:auto; display:inline-block; width: 80%;">
                <span id="valWarning" style="color: var(--red-ui-text-color-error, #910000)"><b>All Values must be unique.</b></span>
                <ol id="node-input-customPayload-container" style="list-style-type:none; margin:0;"></ol>
            </div>
        </div>
        <div class="form-row">
            <a href="#" class="editor-button editor-button-small" id="node-input-add-customPayload" style="margin-bottom: 20px; margin-top:4px; margin-left:125px;"><i class="fa fa-plus"></i> <span>add</span></a>
        </div>
        
        <div id="node-ui-scheduler-tab-static-schedules" class="form-row ui-scheduler-form-row form-row-auto-height"
            style="width: 100%; min-height: 200px; display: flex; flex-flow: column nowrap; max-width: min-content">
            <!-- Row 1 -->
            <div style="display: flex; justify-content: space-between;">
                <label for="node-input-option-container-div" style="vertical-align:top;flex-basis: 120px;">
                    <i class="fa fa-list-alt"></i> 
                    Schedules
                </label>
                <div style="flex-grow: 1; column-gap: 2px; margin-bottom: 2px; margin-top: 0px; display: flex; padding: 0px 0px 0px 4px;">
                    <!-- Toolbar -->
                    <a href="#" accesskey="a" title="Add a new schedule [A]" class="editor-button editor-button-small" id="node-input-add-option">
                        <span><i class="fa fa-plus" style="margin-right: 2px;"></i> <u>a</u>dd</span>
                    </a>
                    <a href="#"  accesskey="s" title="Show dynamic schedules [S]" class="editor-button editor-button-small" id="node-input-show-dynamic">
                        <span><i class="fa fa-table" style="margin-right: 2px;"></i> dynamic <u>s</u>chedules</span>
                    </a>
                    <a href="#" accesskey="x" class="editor-button editor-button-small" id="ui-scheduler-expand-schedules-button" title="Hold the shift key for fullscreen [X]" style="margin-left: auto;">
                        <span class="expand-icon"><i class="fa fa-expand" style="margin-right: 2px;"></i> e<u>x</u>pand</span>
                    </a>
                </div>
            </div>
            <!-- Row 2 (the list) -->
            <div class="red-ui-editableList-border red-ui-editableList-container" id="node-input-option-container-div"
                style="min-width: 300px;box-sizing: border-box;border-radius: 5px;padding: 5px;overflow-y:scroll;display: inline-block;height: calc(100% - -4px);min-height: 150px;">
                <ol id="node-input-option-container" style=" list-style-type:none; margin: 0;" class="ui-sortable"></ol>
            </div>
        </div>

        <div class="form-row ui-scheduler-form-row">
            <label for="node-input-outputField"><i class="fa fa-sign-out"></i> Output property</label>
            <input type="text" id="node-input-outputField" style="width: calc(100% - 130px)" placeholder="payload">
        </div>
        <div class=" form-row ui-scheduler-form-row">
            <label for="node-input-useNewTimePicker"><i class="fa fa-clock-o"></i> Use new timepicker (if available)</label>
            <input type="checkbox" id="node-input-useNewTimePicker" style="display: inline-block; width: auto; margin: 0px 0px 0px 4px;">
        </div>
    
        <style>
            #ui-scheduler-map > div.leaflet-map-pane > div.leaflet-objects-pane > div.leaflet-popup-pane > div > div.leaflet-popup-content-wrapper,
            #ui-scheduler-map > div.leaflet-map-pane > div.leaflet-objects-pane > div.leaflet-popup-pane > div > div.leaflet-popup-tip-container > div {
                background-color: var(--red-ui-primary-background);
                color: var(--red-ui-primary-text-color);
            }
            #ui-scheduler-map > div.leaflet-control-container > div.leaflet-top.leaflet-left > div > a.leaflet-control-zoom-in,
            #ui-scheduler-map > div.leaflet-control-container > div.leaflet-top.leaflet-left > div > a.leaflet-control-zoom-out {
                background-color: var(--red-ui-primary-background);
                color: var(--red-ui-primary-text-color);
            }
    
            .cron-select-period {
                padding: 5px 5px 0px 5px;
            }
    
            .cron-input {
                padding: 5px 5px 0px 5px;
            }
    
            .cron-select-period select,
            .cron-input select,
            .cron-input input[type=radio], 
            .cron-input input[type=checkbox] {
                margin-left: 5px;
                margin-right: 5px;
            }        
    
            table.ui-scheduler-table {
                border: solid 1px var(--red-ui-secondary-background);
                border-collapse: collapse;
                border-spacing: 0;
            }
            table.ui-scheduler-table th {
                background-color: var(--red-ui-primary-background);
                border: solid 1px var(--red-ui-secondary-background);
                color: var(--red-ui-primary-text-color);
                text-align: left;
            }
            table.ui-scheduler-table > tr > td {
                font-family: monospace;
                font-size: 10pt;
                border: solid 1px var(--red-ui-secondary-background);
                color: var(--red-ui-primary-text-color);
                background: var(--red-ui-tertiary-background);
            }
            .ui-scheduler-form-row > label {
                width: 120px !important;
            }
            .ui-scheduler-expression-tip {
                background: var(--red-ui-primary-background);
                color: var(--red-ui-primary-text-color);
                width: 100%;
                max-width: 500px;
                max-height: 300px;
                overflow: auto;
                font-size: 10px;
            }
            .ui-scheduler-form-tip {
                background: var(--red-ui-primary-background);
                color: var(--red-ui-primary-text-color);
                padding: 6px 6px;
                vertical-align: middle;
                font-size: 12px;
                line-height: 20px;
                box-sizing: border-box;
                overflow: auto;
                word-break: keep-all;
            }
            .ui-scheduler-form-tip > div {
                white-space: pre-wrap;
            }
            span .ui-scheduler-form-tip {
                border-radius: 2px;
                border: 1px solid var(--red-ui-secondary-background);
                border-radius: 4px;
                display: inline-block;
            }
            .ui-scheduler-form-tip-spacer {
                display: inline-block;
                width: 100px
            }
            .ui-scheduler-expression {
                font-family: monospace;
                padding-left: 5px;
                padding-right: 5px;
                text-align: left;
                height: 30px;
                vertical-align: middle;
                border-bottom: 1px solid var(--red-ui-primary-text-color)
            }
            #ui-scheduler-map {
                height: 100%;
                padding: 0;
                margin: 0;
            }
            .ui-scheduler-hide-per-location {
                display: none !important;
                visibility: hidden;
            }
            .ui-scheduler-hide-location {
                display: none !important;
                visibility: hidden;
            }
            .ui-scheduler-fullscreen-element {
                padding: 15px;
                z-index: 99999;
                background-color: var(--red-ui-form-background);
            }
            .ui-scheduler-expanded-element {
                position: fixed;
                z-index: 99999;
                top: 0px;
                left: 0px;
                bottom: 0px;
                right: 0px;
                visibility: visible;
                height: unset !important;
                width: unset !important;
                padding: 15px;
                margin: 0px;
                background-color: var(--red-ui-form-background);
            }
            .ui-scheduler-vanish-element {
                display: none !important;
                visibility: hidden !important;
            }
            .ui-scheduler-map-dialog-content {
                padding: 0px 0px 0px 0px;
            }
            .ui-scheduler-map-not-loaded {
                padding: 2px 10px 2px 10px;
            }
            .ui-scheduler-map-loading {
                padding: 2px 10px 2px 10px;
            }
            .ui-scheduler-coordinates {
                font-family: monospace;
                background: var(--red-ui-primary-text-color);
                color: var(--red-ui-primary-background);
                padding-left: 5px;
                padding-right: 5px;
                border: 1px solid var(--red-ui-secondary-background);
            }
            .ui-scheduler-link-button {
                background: none!important;
                border: none!important;
                padding: 0!important;
                cursor: pointer!important;
                color: var(--red-ui-primary-text-color);
            }
            .ui-scheduler-solar-events-table {
                font-size: smaller;
                padding: 0px !important;
                margin: 0px !important;
                width: 100%;
                overflow-wrap: break-word;
                border: 1px solid;
            }
            .ui-scheduler-solar-events-table tr td {
                border: 1px dotted;
            }
            .ui-scheduler-solar-events-table tr th {
                text-align: left;
                border: 1px dotted;
            }
            pre.ui-scheduler-code {
                white-space: pre;
                font-size: 9px;
                position: relative;
                overflow: auto;
                margin: 5px 0;
                padding: 1rem;
                border-radius: 4px;
            }
            .nr-db-ui-manual-size-row {
                display: none;
            }
        </style>  
    </script>